<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n de Capacidad de Inversi√≥n - Dr. Jos√© Moya</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 300;
        }

        .header h2 {
            color: #3498db;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
            max-width: 800px;
            margin: 0 auto;
        }

        .progress-bar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress {
            width: 100%;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 83.33%;
            transition: width 0.3s ease;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px 5px;
            border-radius: 5px;
            margin: 0 2px;
            background: #ecf0f1;
            color: #7f8c8d;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .step.completed {
            background: #27ae60;
            color: white;
        }

        .step.active {
            background: #3498db;
            color: white;
        }

        .inversion-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 25px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            text-align: center;
        }

        .subsection {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }

        .subsection-title {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52,152,219,0.1);
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #e74c3c;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 0.9em;
            display: none;
        }

        .field-error {
            border-color: #e74c3c !important;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.3) !important;
        }

        .field-success {
            border-color: #27ae60 !important;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.3) !important;
        }

        .validation-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .validation-icon.success {
            color: #27ae60;
        }

        .validation-icon.error {
            color: #e74c3c;
        }

        .error-summary {
            background: #f8d7da;
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .error-summary h4 {
            color: #e74c3c;
            margin-bottom: 15px;
        }

        .error-list {
            list-style: none;
            padding: 0;
        }

        .error-list li {
            padding: 5px 0;
            border-bottom: 1px solid #e74c3c;
            position: relative;
            padding-left: 25px;
        }

        .error-list li:before {
            content: "‚ö†Ô∏è";
            position: absolute;
            left: 0;
        }

        .success-message {
            background: #d4edda;
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #155724;
            display: none;
        }

        .income-calculator {
            background: linear-gradient(135deg, #d5f4e6, #ffffff);
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .calculator-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .income-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .income-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
        }

        .income-item label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .income-item input {
            font-size: 16px;
            text-align: right;
            padding: 8px;
        }

        .currency-prefix {
            position: relative;
        }

        .currency-prefix::before {
            content: '$';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-weight: 600;
        }

        .currency-prefix input {
            padding-left: 25px;
        }

        .summary-box {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
        }

        .investment-levels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .investment-card {
            background: white;
            border: 3px solid #ecf0f1;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .investment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .investment-card.selected {
            border-color: #27ae60;
            background: linear-gradient(135deg, #d5f4e6, #ffffff);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(39,174,96,0.2);
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 12px 18px;
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .radio-item:hover {
            border-color: #3498db;
            background: #f0f8ff;
            transform: translateY(-2px);
        }

        .radio-item.selected {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .radio-item input[type="radio"] {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            border-color: #3498db;
            background: #f0f8ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .checkbox-item.checked {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 12px;
            margin-top: 3px;
            transform: scale(1.3);
        }

        .checkbox-content {
            flex: 1;
        }

        .checkbox-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .checkbox-description {
            font-size: 0.9em;
            color: #7f8c8d;
            line-height: 1.4;
        }

        .priority-scale {
            display: flex;
            justify-content: space-between;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #ecf0f1;
        }

        .priority-level {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            margin: 0 5px;
            position: relative;
        }

        .priority-level:hover {
            transform: translateY(-2px);
        }

        .priority-level.low {
            background: #d5f4e6;
            border: 2px solid #27ae60;
        }

        .priority-level.medium {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .priority-level.high {
            background: #ffeaa7;
            border: 2px solid #fdcb6e;
        }

        .priority-level.urgent {
            background: #fab1a0;
            border: 2px solid #e17055;
        }

        .priority-level.selected {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .financial-timeline {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .timeline-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .timeline-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .timeline-option {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeline-option:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .timeline-option.selected {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.8);
            transform: translateY(-2px);
        }

        .travel-assessment {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .insurance-calculator {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .recommendation-preview {
            background: linear-gradient(135deg, #e8f6fd, #ffffff);
            border: 2px solid #3498db;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .recommendation-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .recommendation-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #3498db;
            text-align: left;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(149,165,166,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39,174,96,0.3);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-confidential {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .inversion-container {
                padding: 20px;
            }
            
            .investment-levels {
                grid-template-columns: 1fr;
            }
            
            .income-grid {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .priority-scale {
                flex-direction: column;
                gap: 10px;
            }
            
            .priority-level {
                margin: 0;
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }

            .checkbox-grid {
                grid-template-columns: 1fr;
            }

            .timeline-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
        <!-- Agregar despu√©s del <head> en cada p√°gina del protocolo -->
            <script>
                // Script de protecci√≥n - Agregar a TODAS las p√°ginas del protocolo
                document.addEventListener('DOMContentLoaded', async function() {
                    // Verificar sesi√≥n antes de cargar contenido
                    const sesionValida = await verificarSesionActiva();
                    
                    if (!sesionValida) {
                        // Guardar la p√°gina que intentaba acceder
                        localStorage.setItem('paginaDestino', window.location.pathname);
                        
                        // Mostrar mensaje y redirigir
                        alert('üîí Acceso restringido\n\nDebe iniciar sesi√≥n para acceder a la evaluaci√≥n m√©dica.');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Si la sesi√≥n es v√°lida, continuar cargando la p√°gina
                    inicializarPaginaProtegida();
                });
                
                async function verificarSesionActiva() {
                    try {
                        const response = await fetch('/pidasalud/protocolo-vitiligo/api.php/auth/status', {
                            method: 'GET',
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            return result.authenticated === true;
                        }
                        return false;
                    } catch (error) {
                        console.error('Error verificando sesi√≥n:', error);
                        return false;
                    }
                }
                
                function inicializarPaginaProtegida() {
                    // Aqu√≠ va el c√≥digo de inicializaci√≥n de cada p√°gina
                    console.log('P√°gina protegida cargada correctamente');
                    
                    // Agregar header de navegaci√≥n con logout
                    agregarHeaderProtegido();
                    
                    // Guardar progreso autom√°ticamente
                    guardarProgresoAutomatico();
                }
                
                function agregarHeaderProtegido() {
                    // Crear header con info de usuario y logout
                    const headerHTML = `
                        <div style="
                            background: linear-gradient(135deg, #2c3e50, #3498db);
                            color: white;
                            padding: 15px;
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            z-index: 1000;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        ">
                            <div>
                                <strong>üè• Protocolo Vitiligo - Dr. Jos√© Moya</strong>
                                <span style="margin-left: 20px;">üë§ <span id="nombreUsuarioHeader">Evaluaci√≥n en progreso</span></span>
                            </div>
                            <div>
                                <button onclick="guardarProgreso()" style="
                                    background: rgba(255,255,255,0.2);
                                    border: 1px solid rgba(255,255,255,0.3);
                                    color: white;
                                    padding: 8px 15px;
                                    border-radius: 5px;
                                    margin-right: 10px;
                                    cursor: pointer;
                                ">üíæ Guardar</button>
                                <button onclick="irALogout()" style="
                                    background: #e74c3c;
                                    border: none;
                                    color: white;
                                    padding: 8px 15px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                ">üö™ Cerrar Sesi√≥n</button>
                            </div>
                        </div>
                    `;
                    
                    // Insertar al inicio del body
                    document.body.insertAdjacentHTML('afterbegin', headerHTML);
                    
                    // Ajustar el margen del contenido principal
                    document.body.style.paddingTop = '70px';
                    
                    // Mostrar nombre de usuario si est√° disponible
                    const nombreUsuario = localStorage.getItem('usuario_nombre');
                    if (nombreUsuario) {
                        document.getElementById('nombreUsuarioHeader').textContent = nombreUsuario;
                    }
                }
                
                function guardarProgreso() {
                    const paginaActual = window.location.pathname.split('/').pop();
                    localStorage.setItem('evaluacionEnProgreso', paginaActual);
                    localStorage.setItem('ultimoGuardado', new Date().toISOString());
                    
                    // Mostrar confirmaci√≥n visual
                    mostrarMensajeGuardado();
                }
                
                function guardarProgresoAutomatico() {
                    // Guardar progreso cada 30 segundos
                    setInterval(guardarProgreso, 30000);
                    
                    // Guardar al cambiar de p√°gina
                    window.addEventListener('beforeunload', guardarProgreso);
                }
                
                function mostrarMensajeGuardado() {
                    const mensaje = document.createElement('div');
                    mensaje.innerHTML = 'üíæ Progreso guardado';
                    mensaje.style.cssText = `
                        position: fixed;
                        top: 80px;
                        right: 20px;
                        background: #27ae60;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 5px;
                        z-index: 1001;
                        animation: fadeInOut 3s ease;
                    `;
                    
                    document.body.appendChild(mensaje);
                    setTimeout(() => mensaje.remove(), 3000);
                }
                
                function irALogout() {
                    const confirmar = confirm('¬øEst√° seguro que desea cerrar sesi√≥n?\n\nSu progreso ser√° guardado autom√°ticamente.');
                    if (confirmar) {
                        guardarProgreso();
                        window.location.href = 'logout.html';
                    }
                }
                
                // CSS para la animaci√≥n
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translateX(100%); }
                        20% { opacity: 1; transform: translateX(0); }
                        80% { opacity: 1; transform: translateX(0); }
                        100% { opacity: 0; transform: translateX(100%); }
                    }
                `;
                document.head.appendChild(style);
                </script>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Evaluaci√≥n de Capacidad de Inversi√≥n</h1>
            <h2>Protocolo de Vitiligo - Dr. Jos√© Moya</h2>
            <p>Una evaluaci√≥n honesta y detallada de su capacidad de inversi√≥n nos permite recomendar el plan de tratamiento m√°s apropiado para su situaci√≥n espec√≠fica, asegurando resultados √≥ptimos dentro de sus posibilidades.</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress">
                <div class="progress-fill"></div>
            </div>
            <div class="step-indicator">
                <div class="step completed">Datos B√°sicos</div>
                <div class="step completed">Fitzpatrick</div>
                <div class="step completed">Antecedentes</div>
                <div class="step completed">Vitiligo Actual</div>
                <div class="step active">Capacidad Inversi√≥n</div>
                <div class="step">Reporte</div>
            </div>
        </div>

        <!-- Main Container -->
        <div class="inversion-container">
            <h2 class="section-title">Evaluaci√≥n Financiera Personalizada</h2>
            
            <div class="alert alert-confidential">
                <strong>üîí Informaci√≥n Estrictamente Confidencial:</strong> Toda la informaci√≥n financiera que proporcione est√° protegida por el secreto m√©dico y ser√° utilizada √∫nicamente para personalizar su plan de tratamiento. Sus datos nunca ser√°n compartidos con terceros.
            </div>

            <!-- Secci√≥n: Situaci√≥n Econ√≥mica Actual -->
            <div class="subsection">
                <h3 class="subsection-title">üí∞ Situaci√≥n Econ√≥mica Actual</h3>
                
                <div class="income-calculator">
                    <div class="calculator-title">üìä Calculadora de Ingresos y Gastos</div>
                    
                    <div class="form-group">
                        <label for="pais_residencia">Pa√≠s de Residencia *</label>
                        <select id="pais_residencia" required>
                            <option value="">Seleccione su pa√≠s...</option>
                            <option value="usa">Estados Unidos</option>
                            <option value="canada">Canad√°</option>
                            <option value="mexico">M√©xico</option>
                            <option value="guatemala">Guatemala</option>
                            <option value="honduras">Honduras</option>
                            <option value="el_salvador">El Salvador</option>
                            <option value="nicaragua">Nicaragua</option>
                            <option value="costa_rica">Costa Rica</option>
                            <option value="panama">Panam√°</option>
                            <option value="colombia">Colombia</option>
                            <option value="venezuela">Venezuela</option>
                            <option value="ecuador">Ecuador</option>
                            <option value="peru">Per√∫</option>
                            <option value="bolivia">Bolivia</option>
                            <option value="chile">Chile</option>
                            <option value="argentina">Argentina</option>
                            <option value="uruguay">Uruguay</option>
                            <option value="paraguay">Paraguay</option>
                            <option value="brasil">Brasil</option>
                            <option value="espana">Espa√±a</option>
                            <option value="francia">Francia</option>
                            <option value="italia">Italia</option>
                            <option value="alemania">Alemania</option>
                            <option value="reino_unido">Reino Unido</option>
                            <option value="otro">Otro pa√≠s</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="moneda_local">Moneda de sus ingresos *</label>
                        <select id="moneda_local" required>
                            <option value="">Seleccione...</option>
                            <option value="usd">USD - D√≥lar Estadounidense</option>
                            <option value="eur">EUR - Euro</option>
                            <option value="mxn">MXN - Peso Mexicano</option>
                            <option value="cop">COP - Peso Colombiano</option>
                            <option value="ars">ARS - Peso Argentino</option>
                            <option value="clp">CLP - Peso Chileno</option>
                            <option value="pen">PEN - Sol Peruano</option>
                            <option value="brl">BRL - Real Brasile√±o</option>
                            <option value="cad">CAD - D√≥lar Canadiense</option>
                            <option value="gbp">GBP - Libra Esterlina</option>
                            <option value="otro">Otra moneda</option>
                        </select>
                    </div>

                    <h4 style="color: #27ae60; margin: 20px 0 15px 0;">üìà Ingresos Mensuales</h4>
                    <div class="income-grid">
                        <div class="income-item">
                            <label>Ingresos por Trabajo Principal</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_trabajo" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Ingresos por Trabajo Secundario</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_secundario" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Ingresos por Inversiones/Rentas</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_inversiones" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Pensiones/Jubilaci√≥n</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_pension" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Otros Ingresos</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_otros" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Ingresos Familiares (C√≥nyuge)</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_conyuge" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                    </div>

                    <h4 style="color: #e74c3c; margin: 20px 0 15px 0;">üìâ Gastos Mensuales Fijos</h4>
                    <div class="income-grid">
                        <div class="income-item">
                            <label>Vivienda (Alquiler/Hipoteca)</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_vivienda" placeholder="0" min="0" step="50">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Alimentaci√≥n</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_alimentacion" placeholder="0" min="0" step="50">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Transporte</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_transporte" placeholder="0" min="0" step="50">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Servicios (Agua, Luz, Internet)</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_servicios" placeholder="0" min="0" step="25">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Seguros</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_seguros" placeholder="0" min="0" step="25">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Deudas/Pr√©stamos</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_deudas" placeholder="0" min="0" step="50">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Educaci√≥n</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_educacion" placeholder="0" min="0" step="25">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Salud (Medicamentos, Consultas)</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_salud_actual" placeholder="0" min="0" step="25">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Otros Gastos Fijos</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_otros" placeholder="0" min="0" step="25">
                            </div>
                        </div>
                    </div>

                    <div class="summary-box">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                            <div>
                                <div style="font-size: 1.1em; margin-bottom: 5px;">Ingresos Totales</div>
                                <div style="font-size: 1.8em; font-weight: bold;">$<span id="total_ingresos">0</span></div>
                            </div>
                            <div>
                                <div style="font-size: 1.1em; margin-bottom: 5px;">Gastos Totales</div>
                                <div style="font-size: 1.8em; font-weight: bold;">$<span id="total_gastos">0</span></div>
                            </div>
                            <div>
                                <div style="font-size: 1.1em; margin-bottom: 5px;">Disponible</div>
                                <div style="font-size: 1.8em; font-weight: bold;" id="disponible_color">$<span id="total_disponible">0</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="estabilidad_ingresos">¬øQu√© tan estables son sus ingresos? *</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="estabilidad_ingresos" value="muy_estable" id="estab_muy_estable">
                            <label for="estab_muy_estable">Muy estables (empleado fijo)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="estabilidad_ingresos" value="estable" id="estab_estable">
                            <label for="estab_estable">Estables (contrato definido)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="estabilidad_ingresos" value="variable" id="estab_variable">
                            <label for="estab_variable">Variables (independiente)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="estabilidad_ingresos" value="inestable" id="estab_inestable">
                            <label for="estab_inestable">Inestables (temporales)</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Recursos Disponibles -->
            <div class="subsection">
                <h3 class="subsection-title">üè¶ Recursos y Ahorros Disponibles</h3>
                
                <div class="form-group">
                    <label>¬øCon qu√© recursos cuenta para invertir en su salud? (Seleccione todos los que apliquen)</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_ahorros">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Ahorros Personales</div>
                                <div class="checkbox-description">Dinero ahorrado espec√≠ficamente para salud o emergencias</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_seguro_salud">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Seguro de Salud</div>
                                <div class="checkbox-description">Cobertura m√©dica privada o estatal</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_apoyo_familiar">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Apoyo Familiar</div>
                                <div class="checkbox-description">Familia dispuesta a ayudar financieramente</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_credito">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Acceso a Cr√©dito</div>
                                <div class="checkbox-description">Tarjetas de cr√©dito, pr√©stamos bancarios</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_inversiones">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Inversiones L√≠quidas</div>
                                <div class="checkbox-description">Acciones, bonos, fondos que puede convertir en efectivo</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_propiedades">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Propiedades/Activos</div>
                                <div class="checkbox-description">Bienes que podr√≠a vender o usar como garant√≠a</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_plan_pagos">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Plan de Pagos</div>
                                <div class="checkbox-description">Prefiere financiamiento en cuotas mensuales</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_ninguno">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Recursos Muy Limitados</div>
                                <div class="checkbox-description">Solo puedo cubrir gastos b√°sicos mensuales</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="monto_disponible_inmediato">¬øCu√°nto dinero podr√≠a destinar INMEDIATAMENTE para comenzar un tratamiento? *</label>
                    <select id="monto_disponible_inmediato" required>
                        <option value="">Seleccione...</option>
                        <option value="0_100">$0 - $100</option>
                        <option value="100_300">$100 - $300</option>
                        <option value="300_500">$300 - $500</option>
                        <option value="500_1000">$500 - $1,000</option>
                        <option value="1000_2500">$1,000 - $2,500</option>
                        <option value="2500_5000">$2,500 - $5,000</option>
                        <option value="5000_10000">$5,000 - $10,000</option>
                        <option value="mas_10000">M√°s de $10,000</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="monto_mensual_sostenible">¬øCu√°nto podr√≠a destinar MENSUALMENTE de manera sostenible? *</label>
                    <select id="monto_mensual_sostenible" required>
                        <option value="">Seleccione...</option>
                        <option value="0_50">$0 - $50</option>
                        <option value="50_100">$50 - $100</option>
                        <option value="100_200">$100 - $200</option>
                        <option value="200_500">$200 - $500</option>
                        <option value="500_1000">$500 - $1,000</option>
                        <option value="1000_2000">$1,000 - $2,000</option>
                        <option value="2000_3000">$2,000 - $3,000</option>
                        <option value="mas_3000">M√°s de $3,000</option>
                    </select>
                </div>
            </div>

            <!-- Secci√≥n: Evaluaci√≥n de Seguros -->
            <div class="insurance-calculator">
                <h3 style="color: white; margin-bottom: 20px;">üè• Evaluaci√≥n de Cobertura de Seguros</h3>
                
                <div class="form-group">
                    <label style="color: white;">¬øTiene seguro de salud? *</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="tiene_seguro" value="si_privado" id="seguro_si_privado">
                            <label for="seguro_si_privado">S√≠, privado</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="tiene_seguro" value="si_publico" id="seguro_si_publico">
                            <label for="seguro_si_publico">S√≠, p√∫blico</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="tiene_seguro" value="si_ambos" id="seguro_si_ambos">
                            <label for="seguro_si_ambos">Ambos</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="tiene_seguro" value="no" id="seguro_no">
                            <label for="seguro_no">No tengo</label>
                        </div>
                    </div>
                </div>

                <div id="seguro_detalles" style="display: none;">
                    <div class="form-group">
                        <label style="color: white;">¬øSu seguro cubre tratamientos dermatol√≥gicos especializados?</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" name="cobertura_dermatologia" value="si_completa" id="cob_si_completa">
                                <label for="cob_si_completa">S√≠, cobertura completa</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="cobertura_dermatologia" value="si_parcial" id="cob_si_parcial">
                                <label for="cob_si_parcial">S√≠, cobertura parcial</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="cobertura_dermatologia" value="no" id="cob_no">
                                <label for="cob_no">No cubre</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="cobertura_dermatologia" value="no_se" id="cob_no_se">
                                <label for="cob_no_se">No lo s√©</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="deducible_anual" style="color: white;">¬øCu√°l es su deducible anual aproximado?</label>
                        <div class="currency-prefix">
                            <input type="number" id="deducible_anual" placeholder="0" min="0" step="100">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="copago_especialista" style="color: white;">¬øCu√°nto paga por consulta con especialista?</label>
                        <div class="currency-prefix">
                            <input type="number" id="copago_especialista" placeholder="0" min="0" step="10">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Prioridad y Urgencia -->
            <div class="subsection">
                <h3 class="subsection-title">‚è∞ Prioridad y Urgencia del Tratamiento</h3>
                
                <div class="form-group">
                    <label>¬øQu√© tan prioritario es resolver su Vitiligo en este momento? *</label>
                    <div class="priority-scale">
                        <div class="priority-level low" data-value="baja">
                            <div style="font-size: 2em; margin-bottom: 10px;">üòå</div>
                            <div style="font-weight: 600;">Baja Prioridad</div>
                            <div style="font-size: 0.9em; color: #666;">Puedo esperar, no es urgente</div>
                        </div>
                        <div class="priority-level medium" data-value="media">
                            <div style="font-size: 2em; margin-bottom: 10px;">ü§î</div>
                            <div style="font-weight: 600;">Prioridad Media</div>
                            <div style="font-size: 0.9em; color: #666;">Me gustar√≠a tratarlo pronto</div>
                        </div>
                        <div class="priority-level high" data-value="alta">
                            <div style="font-size: 2em; margin-bottom: 10px;">üòü</div>
                            <div style="font-weight: 600;">Alta Prioridad</div>
                            <div style="font-size: 0.9em; color: #666;">Es importante para m√≠</div>
                        </div>
                        <div class="priority-level urgent" data-value="urgente">
                            <div style="font-size: 2em; margin-bottom: 10px;">üò∞</div>
                            <div style="font-weight: 600;">Urgente</div>
                            <div style="font-size: 0.9em; color: #666;">Necesito tratamiento ya</div>
                        </div>
                    </div>
                    <input type="hidden" id="prioridad_tratamiento" required>
                </div>

                <div class="form-group">
                    <label>¬øQu√© factores influyen en la urgencia de su tratamiento? (Seleccione todos los que apliquen)</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_trabajo">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Impacto Laboral</div>
                                <div class="checkbox-description">Afecta mi trabajo o oportunidades profesionales</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_social">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Impacto Social</div>
                                <div class="checkbox-description">Afecta mis relaciones o vida social</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_autoestima">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Autoestima</div>
                                <div class="checkbox-description">Me afecta psicol√≥gicamente de manera significativa</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_progresion">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Progresi√≥n R√°pida</div>
                                <div class="checkbox-description">El Vitiligo est√° creciendo r√°pidamente</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_evento">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Evento Importante</div>
                                <div class="checkbox-description">Tengo un evento importante pr√≥ximamente</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_familiar">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Presi√≥n Familiar</div>
                                <div class="checkbox-description">Mi familia insiste en que me trate</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Timeline de Tratamiento -->
            <div class="financial-timeline">
                <h3 class="timeline-title">üìÖ Timeline de Inversi√≥n</h3>
                
                <div class="form-group">
                    <label style="color: white;">¬øEn qu√© plazo le gustar√≠a ver resultados significativos? *</label>
                    <div class="timeline-options">
                        <div class="timeline-option" data-value="3_meses">
                            <div style="font-weight: 600;">3 Meses</div>
                            <div style="font-size: 0.9em;">Resultados r√°pidos</div>
                        </div>
                        <div class="timeline-option" data-value="6_meses">
                            <div style="font-weight: 600;">6 Meses</div>
                            <div style="font-size: 0.9em;">Plazo moderado</div>
                        </div>
                        <div class="timeline-option" data-value="12_meses">
                            <div style="font-weight: 600;">12 Meses</div>
                            <div style="font-size: 0.9em;">Tratamiento completo</div>
                        </div>
                        <div class="timeline-option" data-value="18_meses">
                            <div style="font-weight: 600;">18 Meses</div>
                            <div style="font-size: 0.9em;">Proceso gradual</div>
                        </div>
                        <div class="timeline-option" data-value="mas_18">
                            <div style="font-weight: 600;">+18 Meses</div>
                            <div style="font-size: 0.9em;">Sin prisa</div>
                        </div>
                    </div>
                    <input type="hidden" id="timeline_resultados" required>
                </div>

                <div class="form-group">
                    <label for="presupuesto_total_maximo" style="color: white;">¬øCu√°l ser√≠a su presupuesto total m√°ximo para el tratamiento completo?</label>
                    <select id="presupuesto_total_maximo">
                        <option value="">Seleccione...</option>
                        <option value="0_500">$0 - $500</option>
                        <option value="500_1500">$500 - $1,500</option>
                        <option value="1500_3000">$1,500 - $3,000</option>
                        <option value="3000_5000">$3,000 - $5,000</option>
                        <option value="5000_10000">$5,000 - $10,000</option>
                        <option value="10000_20000">$10,000 - $20,000</option>
                        <option value="20000_50000">$20,000 - $50,000</option>
                        <option value="mas_50000">M√°s de $50,000</option>
                        <option value="sin_limite">Sin l√≠mite espec√≠fico</option>
                    </select>
                </div>
            </div>

            <!-- Secci√≥n: Disposici√≥n para Viajar -->
            <div class="travel-assessment">
                <h3 style="color: white; margin-bottom: 20px;">‚úàÔ∏è Disposici√≥n para Viajar por Tratamiento</h3>
                
                <div class="form-group">
                    <label style="color: white;">¬øEstar√≠a dispuesto/a a viajar para recibir tratamiento especializado? *</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="dispuesto_viajar" value="si_cualquier_lugar" id="viaje_si_cualquier">
                            <label for="viaje_si_cualquier">S√≠, a cualquier lugar</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="dispuesto_viajar" value="si_nacional" id="viaje_si_nacional">
                            <label for="viaje_si_nacional">S√≠, dentro de mi pa√≠s</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="dispuesto_viajar" value="si_regional" id="viaje_si_regional">
                            <label for="viaje_si_regional">S√≠, a pa√≠ses cercanos</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="dispuesto_viajar" value="solo_miami" id="viaje_solo_miami">
                            <label for="viaje_solo_miami">Solo a Miami</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="dispuesto_viajar" value="no" id="viaje_no">
                            <label for="viaje_no">No puedo viajar</label>
                        </div>
                    </div>
                </div>

                <div id="viaje_detalles" style="display: none;">
                    <div class="form-group">
                        <label for="presupuesto_viaje" style="color: white;">¬øCu√°nto podr√≠a destinar para gastos de viaje (transporte + alojamiento)?</label>
                        <select id="presupuesto_viaje">
                            <option value="">Seleccione...</option>
                            <option value="0_500">$0 - $500</option>
                            <option value="500_1000">$500 - $1,000</option>
                            <option value="1000_2000">$1,000 - $2,000</option>
                            <option value="2000_5000">$2,000 - $5,000</option>
                            <option value="5000_10000">$5,000 - $10,000</option>
                            <option value="mas_10000">M√°s de $10,000</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="frecuencia_viajes" style="color: white;">¬øCon qu√© frecuencia podr√≠a viajar para seguimiento?</label>
                        <select id="frecuencia_viajes">
                            <option value="">Seleccione...</option>
                            <option value="mensual">Mensualmente</option>
                            <option value="bimensual">Cada 2 meses</option>
                            <option value="trimestral">Cada 3 meses</option>
                            <option value="semestral">Cada 6 meses</option>
                            <option value="anual">Una vez al a√±o</option>
                            <option value="inicial_solo">Solo para consulta inicial</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Preview de Recomendaciones -->
            <div class="recommendation-preview" id="recommendationPreview">
                <div class="recommendation-title">üéØ Vista Previa de Recomendaciones</div>
                <div id="previewContent">
                    <p style="color: #666; font-style: italic;">Complete la evaluaci√≥n para ver recomendaciones personalizadas...</p>
                </div>
            </div>

            <!-- Navigation -->
            <div class="navigation">
                <button class="btn btn-secondary" onclick="previousPage()">‚Üê Vitiligo Actual</button>
                <div>
                    <button class="btn btn-success" onclick="saveProgress()" style="margin-right: 15px;">üíæ Guardar Progreso</button>
                    <button class="btn btn-primary" onclick="generateFinalReport()">Generar Reporte Final ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let inversionData = {};
        let calculationResults = {};

        // Funci√≥n mejorada para validaci√≥n completa
        function validateForm() {
            const errors = [];
            let isValid = true;

            // Limpiar errores previos
            clearValidationErrors();

            // Definir campos requeridos con sus mensajes personalizados
            const requiredFields = [
                {
                    id: 'pais_residencia',
                    message: 'Por favor seleccione su pa√≠s de residencia'
                },
                {
                    id: 'moneda_local',
                    message: 'Por favor indique la moneda de sus ingresos'
                },
                {
                    id: 'monto_disponible_inmediato',
                    message: 'Por favor indique cu√°nto puede destinar inmediatamente'
                },
                {
                    id: 'monto_mensual_sostenible',
                    message: 'Por favor indique cu√°nto puede destinar mensualmente'
                }
            ];

            // Validar campos select requeridos
            requiredFields.forEach(fieldData => {
                const field = document.getElementById(fieldData.id);
                if (!field || !field.value || field.value === '') {
                    showFieldError(field, fieldData.message);
                    errors.push(fieldData.message);
                    isValid = false;
                } else {
                    showFieldSuccess(field);
                }
            });

            // Validar radio buttons requeridos
            const requiredRadios = [
                {
                    name: 'estabilidad_ingresos',
                    message: 'Por favor indique qu√© tan estables son sus ingresos'
                },
                {
                    name: 'tiene_seguro',
                    message: 'Por favor indique si tiene seguro de salud'
                },
                {
                    name: 'dispuesto_viajar',
                    message: 'Por favor indique si est√° dispuesto/a a viajar por tratamiento'
                }
            ];

            requiredRadios.forEach(radioData => {
                const checked = document.querySelector(`input[name="${radioData.name}"]:checked`);
                if (!checked) {
                    errors.push(radioData.message);
                    highlightRadioGroupError(radioData.name);
                    isValid = false;
                } else {
                    clearRadioGroupError(radioData.name);
                }
            });

            // Validar selecciones especiales
            const prioridadElement = document.querySelector('.priority-level.selected');
            if (!prioridadElement) {
                errors.push('Por favor seleccione la prioridad del tratamiento');
                isValid = false;
            }

            const timelineElement = document.querySelector('.timeline-option.selected');
            if (!timelineElement) {
                errors.push('Por favor seleccione el plazo para ver resultados');
                isValid = false;
            }

            // Validaci√≥n de datos financieros
            const totalIngresos = calculationResults.totalIngresos || 0;
            const totalGastos = calculationResults.totalGastos || 0;
            
            if (totalIngresos === 0) {
                errors.push('Por favor ingrese al menos un tipo de ingreso');
                isValid = false;
            }

            if (totalGastos > totalIngresos * 1.2) {
                errors.push('Sus gastos exceden significativamente sus ingresos. Esto podr√≠a afectar las opciones de tratamiento disponibles.');
            }

            // Mostrar resumen de errores
            if (!isValid) {
                showErrorSummary(errors);
                scrollToFirstError();
            } else {
                hideErrorSummary();
            }

            return isValid;
        }

        // Funci√≥n para mostrar error en campo espec√≠fico
        function showFieldError(field, message) {
            if (!field) return;
            
            field.classList.add('field-error');
            field.classList.remove('field-success');
            
            // Crear o actualizar mensaje de error
            let errorDiv = field.parentNode.querySelector('.error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                field.parentNode.appendChild(errorDiv);
            }
            
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';

            // Agregar icono de error
            addValidationIcon(field, 'error');
        }

        // Funci√≥n para mostrar √©xito en campo
        function showFieldSuccess(field) {
            if (!field) return;
            
            field.classList.add('field-success');
            field.classList.remove('field-error');
            
            // Ocultar mensaje de error
            const errorDiv = field.parentNode.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }

            // Agregar icono de √©xito
            addValidationIcon(field, 'success');
        }

        // Funci√≥n para agregar iconos de validaci√≥n
        function addValidationIcon(field, type) {
            // Remover icono existente
            const existingIcon = field.parentNode.querySelector('.validation-icon');
            if (existingIcon) {
                existingIcon.remove();
            }

            // Agregar nuevo icono
            const icon = document.createElement('span');
            icon.className = `validation-icon ${type}`;
            icon.textContent = type === 'success' ? '‚úì' : '‚úó';
            field.parentNode.appendChild(icon);
        }

        // Funci√≥n para limpiar errores de validaci√≥n
        function clearValidationErrors() {
            document.querySelectorAll('.field-error').forEach(field => {
                field.classList.remove('field-error');
            });
            
            document.querySelectorAll('.error-message').forEach(msg => {
                msg.style.display = 'none';
            });
            
            document.querySelectorAll('.validation-icon').forEach(icon => {
                icon.remove();
            });

            hideErrorSummary();
        }

        // Funci√≥n para resaltar error en grupo de radio buttons
        function highlightRadioGroupError(radioName) {
            const radioContainer = document.querySelector(`input[name="${radioName}"]`).closest('.subsection');
            if (radioContainer) {
                radioContainer.style.borderLeft = '5px solid #e74c3c';
                radioContainer.style.backgroundColor = '#fdf2f2';
            }
        }

        // Funci√≥n para limpiar error en grupo de radio buttons
        function clearRadioGroupError(radioName) {
            const radioContainer = document.querySelector(`input[name="${radioName}"]`).closest('.subsection');
            if (radioContainer) {
                radioContainer.style.borderLeft = '5px solid #3498db';
                radioContainer.style.backgroundColor = '#f8f9fa';
            }
        }

        // Funci√≥n para mostrar resumen de errores
        function showErrorSummary(errors) {
            let errorSummary = document.getElementById('errorSummary');
            
            if (!errorSummary) {
                errorSummary = document.createElement('div');
                errorSummary.id = 'errorSummary';
                errorSummary.className = 'error-summary';
                
                const container = document.querySelector('.inversion-container');
                container.insertBefore(errorSummary, container.firstChild);
            }

            errorSummary.innerHTML = `
                <h4>‚ö†Ô∏è Por favor corrija los siguientes errores:</h4>
                <ul class="error-list">
                    ${errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            `;
            
            errorSummary.style.display = 'block';
        }

        // Funci√≥n para ocultar resumen de errores
        function hideErrorSummary() {
            const errorSummary = document.getElementById('errorSummary');
            if (errorSummary) {
                errorSummary.style.display = 'none';
            }
        }

        // Funci√≥n para hacer scroll al primer error
        function scrollToFirstError() {
            const firstError = document.querySelector('.field-error, .error-summary');
            if (firstError) {
                firstError.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }

        // Funci√≥n para mostrar mensaje de √©xito
        function showSuccessMessage(message) {
            let successDiv = document.getElementById('successMessage');
            
            if (!successDiv) {
                successDiv = document.createElement('div');
                successDiv.id = 'successMessage';
                successDiv.className = 'success-message';
                
                const container = document.querySelector('.inversion-container');
                container.insertBefore(successDiv, container.firstChild);
            }

            successDiv.innerHTML = `‚úÖ ${message}`;
            successDiv.style.display = 'block';

            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Funci√≥n para mostrar mensaje de advertencia
        function showWarningMessage(message) {
            let warningDiv = document.getElementById('warningMessage');
            
            if (!warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'warningMessage';
                warningDiv.className = 'alert alert-warning';
                warningDiv.style.margin = '20px 0';
                
                const container = document.querySelector('.inversion-container');
                container.insertBefore(warningDiv, container.firstChild);
            }

            warningDiv.innerHTML = `‚ö†Ô∏è ${message}`;
            warningDiv.style.display = 'block';

            // Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                warningDiv.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n mejorada para guardar progreso
        function saveProgress() {
            try {
                inversionData = collectAllData();
                localStorage.setItem('capacidadInversionData', JSON.stringify(inversionData));
                
                // Marcar paso como completado
                localStorage.setItem('capacidadInversionCompleted', 'true');
                
                // Mostrar confirmaci√≥n visual
                showSuccessMessage('Progreso guardado exitosamente. Sus datos financieros est√°n seguros y encriptados.');
                
                // Actualizar barra de progreso
                updateProgressBar();
                
                console.log('‚úÖ Capacidad de inversi√≥n guardada exitosamente');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error guardando progreso:', error);
                alert('Error al guardar el progreso. Por favor intente nuevamente.');
                return false;
            }
        }

        // Funci√≥n para actualizar barra de progreso
        function updateProgressBar() {
            const progressFill = document.querySelector('.progress-fill');
            const currentStep = document.querySelector('.step.active');
            
            if (progressFill) {
                progressFill.style.width = '100%'; // Paso completado
            }
            
            if (currentStep) {
                currentStep.classList.remove('active');
                currentStep.classList.add('completed');
            }
        }

        // Funci√≥n mejorada para cargar datos guardados
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('capacidadInversionData');
                if (savedData) {
                    inversionData = JSON.parse(savedData);
                    
                    // Restaurar campos de formulario
                    restoreFormFields(inversionData);
                    
                    // Restaurar selecciones especiales
                    restoreSpecialSelections(inversionData);
                    
                    // Recalcular despu√©s de cargar
                    setTimeout(() => {
                        calculateFinancialSummary();
                        updateRecommendationPreview();
                    }, 100);

                    console.log('‚úÖ Datos de capacidad de inversi√≥n cargados exitosamente');
                    return true;
                }
                return false;
                
            } catch (error) {
                console.error('‚ùå Error cargando datos guardados:', error);
                return false;
            }
        }

        // Funci√≥n para restaurar campos de formulario
        function restoreFormFields(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                if (element && data[key] !== undefined && data[key] !== null) {
                    if (element.type === 'checkbox') {
                        element.checked = true;
                        element.closest('.checkbox-item')?.classList.add('checked');
                    } else if (element.type === 'radio' && element.value === data[key]) {
                        element.checked = true;
                        element.closest('.radio-item')?.classList.add('selected');
                    } else if (element.type !== 'radio') {
                        element.value = data[key];
                    }
                    
                    // Disparar eventos para actualizar validaciones
                    element.dispatchEvent(new Event('input', { bubbles: true }));
                    element.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });

            // Restaurar recursos seleccionados
            if (data.recursos && Array.isArray(data.recursos)) {
                data.recursos.forEach(recursoId => {
                    const recurso = document.getElementById(recursoId);
                    if (recurso) {
                        recurso.checked = true;
                        recurso.closest('.checkbox-item')?.classList.add('checked');
                    }
                });
            }
        }

        // Funci√≥n para restaurar selecciones especiales
        function restoreSpecialSelections(data) {
            // Restaurar prioridad
            if (data.prioridad_tratamiento) {
                const priorityElement = document.querySelector(`[data-value="${data.prioridad_tratamiento}"]`);
                if (priorityElement && priorityElement.classList.contains('priority-level')) {
                    document.querySelectorAll('.priority-level').forEach(el => el.classList.remove('selected'));
                    priorityElement.classList.add('selected');
                    document.getElementById('prioridad_tratamiento').value = data.prioridad_tratamiento;
                }
            }

            // Restaurar timeline
            if (data.timeline_resultados) {
                const timelineElement = document.querySelector(`[data-value="${data.timeline_resultados}"]`);
                if (timelineElement && timelineElement.classList.contains('timeline-option')) {
                    document.querySelectorAll('.timeline-option').forEach(el => el.classList.remove('selected'));
                    timelineElement.classList.add('selected');
                    document.getElementById('timeline_resultados').value = data.timeline_resultados;
                }
            }
        }

        // Funci√≥n mejorada para ir a p√°gina anterior
        function previousPage() {
            // Guardar progreso antes de salir
            const saved = saveProgress();
            
            if (saved) {
                setTimeout(() => {
                    window.location.href = 'vitiligo_actual.html';
                }, 500); // Peque√±o delay para que se vea el mensaje de √©xito
            }
        }

        // Funci√≥n para generar reporte final
        function generateFinalReport() {
            // Validar formulario
            if (!validateForm()) {
                return;
            }

            // Mostrar indicador de carga
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Generando reporte...';
            button.disabled = true;

            try {
                // Guardar datos finales
                saveProgress();
                
                // Combinar todos los datos de pasos anteriores
                const allData = {
                    capacidadInversion: collectAllData(),
                    datosBasicos: JSON.parse(localStorage.getItem('datosBasicos') || '{}'),
                    fitzpatrick: JSON.parse(localStorage.getItem('fitzpatrickData') || '{}'),
                    antecedentes: JSON.parse(localStorage.getItem('antecedentesData') || '{}'),
                    vitiligoActual: JSON.parse(localStorage.getItem('vitiligoActualData') || '{}')
                };

                // Guardar datos completos
                localStorage.setItem('reporteCompleto', JSON.stringify(allData));
                
                // Mostrar √©xito
                showSuccessMessage('Datos guardados exitosamente. Generando su reporte personalizado...');
                
                // Redireccionar al reporte final despu√©s de un breve delay
                setTimeout(() => {
                    window.location.href = 'reporte_final.html';
                }, 1500);

            } catch (error) {
                console.error('Error al guardar datos:', error);
                alert('‚ùå Error al procesar sus datos. Por favor intente nuevamente.');
                
                // Restaurar bot√≥n
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Calcular resumen financiero
        function calculateFinancialSummary() {
            const incomeInputs = [
                'ingreso_trabajo', 'ingreso_secundario', 'ingreso_inversiones', 
                'ingreso_pension', 'ingreso_otros', 'ingreso_conyuge'
            ];
            
            const expenseInputs = [
                'gasto_vivienda', 'gasto_alimentacion', 'gasto_transporte', 
                'gasto_servicios', 'gasto_seguros', 'gasto_deudas', 
                'gasto_educacion', 'gasto_salud_actual', 'gasto_otros'
            ];

            let totalIngresos = 0;
            let totalGastos = 0;

            incomeInputs.forEach(id => {
                const value = parseFloat(document.getElementById(id).value) || 0;
                totalIngresos += value;
            });

            expenseInputs.forEach(id => {
                const value = parseFloat(document.getElementById(id).value) || 0;
                totalGastos += value;
            });

            const disponible = totalIngresos - totalGastos;

            // Actualizar display
            document.getElementById('total_ingresos').textContent = totalIngresos.toLocaleString();
            document.getElementById('total_gastos').textContent = totalGastos.toLocaleString();
            document.getElementById('total_disponible').textContent = disponible.toLocaleString();

            // Colorear seg√∫n disponibilidad
            const disponibleElement = document.getElementById('disponible_color');
            if (disponible > 0) {
                disponibleElement.style.color = '#27ae60';
            } else if (disponible < 0) {
                disponibleElement.style.color = '#e74c3c';
            } else {
                disponibleElement.style.color = '#f39c12';
            }

            // Guardar resultados
            calculationResults = {
                totalIngresos,
                totalGastos,
                disponible,
                porcentajeDisponible: totalIngresos > 0 ? (disponible / totalIngresos) * 100 : 0
            };
        }

        // Inicializar calculadoras
        function initializeCalculators() {
            calculateFinancialSummary();
        }

        // Funci√≥n para selecci√≥n de prioridad
        function initializePrioritySelection() {
            const priorityLevels = document.querySelectorAll('.priority-level');
            
            priorityLevels.forEach(level => {
                level.addEventListener('click', function() {
                    // Remover selecci√≥n previa
                    priorityLevels.forEach(l => l.classList.remove('selected'));
                    // Seleccionar actual
                    this.classList.add('selected');
                    // Guardar valor
                    document.getElementById('prioridad_tratamiento').value = this.dataset.value;
                    updateRecommendationPreview();
                });
            });
        }

        // Funci√≥n para selecci√≥n de timeline
        function initializeTimelineSelection() {
            const timelineOptions = document.querySelectorAll('.timeline-option');
            
            timelineOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remover selecci√≥n previa
                    timelineOptions.forEach(o => o.classList.remove('selected'));
                    // Seleccionar actual
                    this.classList.add('selected');
                    // Guardar valor
                    document.getElementById('timeline_resultados').value = this.dataset.value;
                    updateRecommendationPreview();
                });
            });
        }

        // Funci√≥n para mostrar/ocultar detalles de seguro
        function initializeInsuranceToggles() {
            const seguroOptions = document.querySelectorAll('input[name="tiene_seguro"]');
            const seguroDetalles = document.getElementById('seguro_detalles');

            seguroOptions.forEach(option => {
                option.addEventListener('change', function() {
                    if (this.value !== 'no') {
                        seguroDetalles.style.display = 'block';
                    } else {
                        seguroDetalles.style.display = 'none';
                    }
                });
            });
        }

        // Funci√≥n para mostrar/ocultar detalles de viaje
        function initializeTravelToggles() {
            const viajeOptions = document.querySelectorAll('input[name="dispuesto_viajar"]');
            const viajeDetalles = document.getElementById('viaje_detalles');

            viajeOptions.forEach(option => {
                option.addEventListener('change', function() {
                    if (this.value !== 'no') {
                        viajeDetalles.style.display = 'block';
                    } else {
                        viajeDetalles.style.display = 'none';
                    }
                });
            });
        }

        // Funci√≥n para manejar recursos mutuamente excluyentes
        function initializeResourceToggles() {
            const recursoNinguno = document.getElementById('recurso_ninguno');
            const otrosRecursos = document.querySelectorAll('.checkbox-item input[type="checkbox"]:not(#recurso_ninguno)');

            recursoNinguno.addEventListener('change', function() {
                if (this.checked) {
                    otrosRecursos.forEach(recurso => {
                        if (recurso.closest('.checkbox-item')) {
                            recurso.checked = false;
                            recurso.closest('.checkbox-item').classList.remove('checked');
                        }
                    });
                }
            });

            otrosRecursos.forEach(recurso => {
                recurso.addEventListener('change', function() {
                    if (this.checked && recursoNinguno.checked) {
                        recursoNinguno.checked = false;
                        recursoNinguno.closest('.checkbox-item').classList.remove('checked');
                    }
                });
            });

            // Agregar funcionalidad visual a checkboxes
            document.querySelectorAll('.checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            item.classList.add('checked');
                        } else {
                            item.classList.remove('checked');
                        }
                    });
                }
            });

            // Agregar funcionalidad visual a radio buttons
            document.querySelectorAll('.radio-item').forEach(item => {
                const radio = item.querySelector('input[type="radio"]');
                if (radio) {
                    radio.addEventListener('change', function() {
                        // Remover selecci√≥n de otros en el mismo grupo
                        const name = this.name;
                        document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                            r.closest('.radio-item').classList.remove('selected');
                        });
                        // Agregar selecci√≥n al actual
                        item.classList.add('selected');
                    });
                }
            });
        }

        // Validaci√≥n mejorada en tiempo real
        function setupRealTimeValidation() {
            // Configurar validaci√≥n para campos requeridos
            const requiredSelects = ['pais_residencia', 'moneda_local', 'monto_disponible_inmediato', 'monto_mensual_sostenible'];
            
            requiredSelects.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', function() {
                        if (this.value && this.value !== '') {
                            showFieldSuccess(this);
                        } else {
                            showFieldError(this, `Este campo es requerido`);
                        }
                        updateRecommendationPreview();
                    });
                    
                    field.addEventListener('blur', function() {
                        if (!this.value || this.value === '') {
                            showFieldError(this, `Por favor seleccione una opci√≥n`);
                        }
                    });
                }
            });

            // Configurar validaci√≥n para radio buttons
            const radioGroups = ['estabilidad_ingresos', 'tiene_seguro', 'dispuesto_viajar'];
            
            radioGroups.forEach(groupName => {
                const radios = document.querySelectorAll(`input[name="${groupName}"]`);
                radios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        clearRadioGroupError(groupName);
                        updateRecommendationPreview();
                    });
                });
            });

            // Configurar validaci√≥n para campos num√©ricos
            const numericInputs = document.querySelectorAll('input[type="number"]');
            numericInputs.forEach(input => {
                input.addEventListener('input', function() {
                    // Validar que sea un n√∫mero v√°lido
                    const value = parseFloat(this.value);
                    if (this.value !== '' && (isNaN(value) || value < 0)) {
                        showFieldError(this, 'Por favor ingrese un n√∫mero v√°lido mayor o igual a 0');
                    } else if (this.value !== '') {
                        showFieldSuccess(this);
                    }
                });

                input.addEventListener('blur', function() {
                    // Formatear el n√∫mero al perder el foco
                    if (this.value && !isNaN(this.value)) {
                        this.value = parseFloat(this.value).toFixed(0);
                    }
                });
            });

            // Configurar validaci√≥n para checkboxes de recursos
            const resourceCheckboxes = document.querySelectorAll('.checkbox-item input[type="checkbox"]');
            resourceCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // Verificar que al menos uno est√© seleccionado
                    const anySelected = Array.from(resourceCheckboxes).some(cb => cb.checked);
                    if (!anySelected) {
                        // Mostrar advertencia si no hay recursos seleccionados
                        setTimeout(() => {
                            if (!Array.from(resourceCheckboxes).some(cb => cb.checked)) {
                                showWarningMessage('Se recomienda seleccionar al menos un recurso disponible para obtener mejores recomendaciones.');
                            }
                        }, 100);
                    }
                    updateRecommendationPreview();
                });
            });
        }

        // Configurar actualizaciones en tiempo real mejoradas
        function setupRealTimeUpdates() {
            // Calculadora de ingresos y gastos
            const incomeInputs = document.querySelectorAll('#ingreso_trabajo, #ingreso_secundario, #ingreso_inversiones, #ingreso_pension, #ingreso_otros, #ingreso_conyuge');
            const expenseInputs = document.querySelectorAll('#gasto_vivienda, #gasto_alimentacion, #gasto_transporte, #gasto_servicios, #gasto_seguros, #gasto_deudas, #gasto_educacion, #gasto_salud_actual, #gasto_otros');

            [...incomeInputs, ...expenseInputs].forEach(input => {
                input.addEventListener('input', function() {
                    calculateFinancialSummary();
                    
                    // Validaci√≥n contextual
                    const value = parseFloat(this.value) || 0;
                    const isIncome = incomeInputs.includes(this);
                    
                    if (isIncome && value > 50000) {
                        showWarningMessage('Ingreso alto detectado. Esto podr√≠a abrir opciones de tratamiento premium.');
                    }
                    
                    // Actualizar recomendaciones despu√©s de cambios financieros
                    setTimeout(updateRecommendationPreview, 300);
                });
            });

            // Configurar validaci√≥n en tiempo real
            setupRealTimeValidation();
        }

        // Funci√≥n para actualizar preview de recomendaciones
        function updateRecommendationPreview() {
            const data = collectAllData();
            const investmentLevel = calculateInvestmentLevel(data);
            const preview = generatePreviewRecommendations(investmentLevel, data);
            
            document.getElementById('previewContent').innerHTML = preview;
        }

        // Calcular nivel de inversi√≥n
        function calculateInvestmentLevel(data) {
            let score = 0;

            // Factor: ingresos disponibles
            const disponible = calculationResults.disponible || 0;
            if (disponible > 3000) score += 3;
            else if (disponible > 1000) score += 2;
            else if (disponible > 500) score += 1;

            // Factor: monto mensual sostenible
            const mensual = data.monto_mensual_sostenible;
            if (mensual === 'mas_3000' || mensual === '2000_3000') score += 3;
            else if (mensual === '1000_2000' || mensual === '500_1000') score += 2;
            else if (mensual === '200_500') score += 1;

            // Factor: monto disponible inmediato
            const inmediato = data.monto_disponible_inmediato;
            if (inmediato === 'mas_10000' || inmediato === '5000_10000') score += 3;
            else if (inmediato === '2500_5000' || inmediato === '1000_2500') score += 2;
            else if (inmediato === '500_1000') score += 1;

            // Factor: recursos disponibles
            const recursos = data.recursos || [];
            if (recursos.includes('recurso_ahorros')) score += 1;
            if (recursos.includes('recurso_seguro_salud')) score += 1;
            if (recursos.includes('recurso_apoyo_familiar')) score += 1;
            if (recursos.includes('recurso_credito')) score += 1;

            // Factor: prioridad
            const prioridad = data.prioridad_tratamiento;
            if (prioridad === 'urgente') score += 2;
            else if (prioridad === 'alta') score += 1;

            // Factor: estabilidad de ingresos
            const estabilidad = data.estabilidad_ingresos;
            if (estabilidad === 'muy_estable' || estabilidad === 'estable') score += 1;

            // Determinar nivel
            if (score >= 10) return 3; // Inversi√≥n completa
            else if (score >= 6) return 2; // Inversi√≥n moderada
            else return 1; // Inversi√≥n limitada
        }

        // Generar preview de recomendaciones
        function generatePreviewRecommendations(level, data) {
            let html = '';

            if (level === 1) {
                html = `
                    <div class="recommendation-card" style="border-left-color: #e74c3c;">
                        <h4 style="color: #e74c3c;">üî¥ Plan Esencial - Inversi√≥n Limitada</h4>
                        <p><strong>Inversi√≥n mensual estimada:</strong> $200 - $500</p>
                        <ul>
                            <li>Consulta virtual inicial completa</li>
                            <li>Protocolo b√°sico con suplementos esenciales</li>
                            <li>Fototerapia casera con l√°mpara UVB-NB</li>
                            <li>Seguimiento mensual virtual</li>
                            <li>Plan de pagos sin intereses disponible</li>
                        </ul>
                    </div>
                `;
            } else if (level === 2) {
                html = `
                    <div class="recommendation-card" style="border-left-color: #f39c12;">
                        <h4 style="color: #f39c12;">üü° Plan Integral - Inversi√≥n Moderada</h4>
                        <p><strong>Inversi√≥n mensual estimada:</strong> $500 - $1,200</p>
                        <ul>
                            <li>Consulta presencial o virtual premium</li>
                            <li>An√°lisis gen√©tico completo incluido</li>
                            <li>Protocolo avanzado personalizado</li>
                            <li>Fototerapia profesional supervisada</li>
                            <li>Laboratorios especializados incluidos</li>
                        </ul>
                    </div>
                `;
            } else {
                html = `
                    <div class="recommendation-card" style="border-left-color: #27ae60;">
                        <h4 style="color: #27ae60;">üü¢ Plan Premium - Inversi√≥n Completa</h4>
                        <p><strong>Inversi√≥n mensual estimada:</strong> $1,200 - $3,000</p>
                        <ul>
                            <li>Protocolo completo con todos los tratamientos</li>
                            <li>Consultas presenciales en Miami</li>
                            <li>Tratamientos biol√≥gicos cuando sean necesarios</li>
                            <li>Seguimiento VIP con acceso 24/7</li>
                            <li>Garant√≠a de resultados premium</li>
                        </ul>
                    </div>
                `;
            }

            // Agregar informaci√≥n sobre viajes si es relevante
            if (data.dispuesto_viajar && data.dispuesto_viajar !== 'no') {
                html += `
                    <div style="margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                        <strong>üí° Recomendaci√≥n adicional:</strong> Dado que est√° dispuesto/a a viajar, 
                        podemos optimizar su plan combinando consultas presenciales estrat√©gicas con 
                        seguimiento virtual, maximizando la efectividad del tratamiento.
                    </div>
                `;
            }

            return html;
        }

        // Funci√≥n para recopilar todos los datos
        function collectAllData() {
            const data = {};
            
            // Recopilar todos los inputs
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    if (input.checked) {
                        if (!data.recursos) data.recursos = [];
                        data.recursos.push(input.id);
                    }
                } else if (input.type === 'radio') {
                    if (input.checked) {
                        data[input.name] = input.value;
                    }
                } else if (input.value) {
                    data[input.id || input.name] = input.value;
                }
            });

            // Incluir resultados de c√°lculos
            data.calculationResults = calculationResults;

            // Incluir selecciones especiales
            const selectedPriority = document.querySelector('.priority-level.selected');
            if (selectedPriority) {
                data.prioridad_tratamiento = selectedPriority.dataset.value;
            }

            const selectedTimeline = document.querySelector('.timeline-option.selected');
            if (selectedTimeline) {
                data.timeline_resultados = selectedTimeline.dataset.value;
            }

            return data;
        }

        // Configuraci√≥n de atajos de teclado
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl + S para guardar
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveProgress();
                }
                
                // Escape para limpiar errores
                if (e.key === 'Escape') {
                    clearValidationErrors();
                }
            });
        }

        // Configurar auto-guardado
        function setupAutoSave() {
            let autoSaveTimer;
            
            function triggerAutoSave() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    saveProgress();
                }, 30000); // Auto-guardar cada 30 segundos
            }

            // Configurar auto-guardado en cambios
            document.addEventListener('input', triggerAutoSave);
            document.addEventListener('change', triggerAutoSave);
        }

        // Prevenir p√©rdida de datos
        function setupBeforeUnload() {
            window.addEventListener('beforeunload', function(e) {
                const hasUnsavedChanges = checkForUnsavedChanges();
                if (hasUnsavedChanges) {
                    const message = 'Tiene cambios sin guardar. ¬øEst√° seguro que desea salir?';
                    e.returnValue = message;
                    return message;
                }
            });
        }

        // Verificar cambios sin guardar
        function checkForUnsavedChanges() {
            const currentData = collectAllData();
            const savedData = JSON.parse(localStorage.getItem('capacidadInversionData') || '{}');
            
            return JSON.stringify(currentData) !== JSON.stringify(savedData);
        }

        // Configuraci√≥n mejorada de inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando Capacidad de Inversi√≥n...');
            
            try {
                // Inicializar componentes principales
                initializeCalculators();
                initializePrioritySelection();
                initializeTimelineSelection();
                initializeInsuranceToggles();
                initializeTravelToggles();
                initializeResourceToggles();
                
                // Configurar actualizaciones y validaciones
                setupRealTimeUpdates();
                setupKeyboardShortcuts();
                setupAutoSave();
                setupBeforeUnload();
                
                // Cargar datos guardados
                const dataLoaded = loadSavedData();
                
                // Mostrar mensaje de bienvenida
                if (dataLoaded) {
                    showSuccessMessage('Datos previos cargados exitosamente. Puede continuar donde lo dej√≥.');
                } else {
                    console.log('üìã Iniciando evaluaci√≥n de capacidad de inversi√≥n...');
                }
                
                console.log('‚úÖ Inicializaci√≥n completada exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error durante la inicializaci√≥n:', error);
                alert('Error al cargar la p√°gina. Por favor recargue el navegador.');
            }
        });
    </script>
</body>
</html>

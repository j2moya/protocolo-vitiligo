<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Final - Protocolo Vitiligo Dr. Jos√© Moya</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 300;
        }

        .header h2 {
            color: #3498db;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
            max-width: 800px;
            margin: 0 auto;
        }

        .progress-bar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress {
            width: 100%;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 100%;
            transition: width 0.3s ease;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px 5px;
            border-radius: 5px;
            margin: 0 2px;
            background: #27ae60;
            color: white;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .step.active {
            background: #3498db;
            color: white;
        }

        .reporte-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .report-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 3px solid #3498db;
        }

        .report-title {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .report-subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .report-date {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 600;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .section-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .patient-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ecf0f1;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .card-content {
            color: #666;
            line-height: 1.5;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39,174,96,0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23,162,184,0.3);
        }

        .alert {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        .actions {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .print-hidden {
            display: block;
        }

        @media print {
            body {
                background: white;
                color: black;
            }
            
            .print-hidden {
                display: none !important;
            }
            
            .container {
                max-width: 100%;
                padding: 0;
            }
            
            .section {
                break-inside: avoid;
                margin-bottom: 20px;
            }
            
            .btn {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .reporte-container {
                padding: 20px;
            }
            
            .patient-summary {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos adicionales para el reporte completo */
        .risk-assessment {
            background: linear-gradient(135deg, #e8f6fd, #ffffff);
            border: 2px solid #3498db;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .risk-level {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .low-risk { color: #27ae60; }
        .medium-risk { color: #f39c12; }
        .high-risk { color: #e74c3c; }

        .treatment-plan {
            background: linear-gradient(135deg, #d5f4e6, #ffffff);
            border: 2px solid #27ae60;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .plan-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #27ae60;
            margin-bottom: 20px;
            text-align: center;
        }

        .plan-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .plan-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .plan-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .plan-section ul {
            list-style: none;
            padding: 0;
        }

        .plan-section li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
            position: relative;
            padding-left: 25px;
        }

        .plan-section li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #27ae60;
            font-weight: bold;
        }

        .investment-breakdown {
            background: #2c3e50;
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .investment-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            text-align: center;
        }

        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .cost-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .cost-amount {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .cost-description {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .contact-section {
            background: #2c3e50;
            color: white;
            border-radius: 15px;
            padding: 40px;
            margin: 40px 0;
            text-align: center;
        }

        .contact-title {
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        .contact-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }

        .contact-method {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
        }

        .contact-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .contact-details {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .footer {
            background: #2c3e50;
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-top: 40px;
        }

        .footer-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .disclaimer {
            font-size: 0.9em;
            opacity: 0.8;
            line-height: 1.6;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Reporte Integral Personalizado</h1>
            <h2>Protocolo de Vitiligo - Dr. Jos√© Moya</h2>
            <p>Evaluaci√≥n completa con recomendaciones espec√≠ficas para su caso √∫nico</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar print-hidden">
            <div class="progress">
                <div class="progress-fill"></div>
            </div>
            <div class="step-indicator">
                <div class="step">Datos B√°sicos</div>
                <div class="step">Fitzpatrick</div>
                <div class="step">Antecedentes</div>
                <div class="step">Vitiligo Actual</div>
                <div class="step">Capacidad Inversi√≥n</div>
                <div class="step active">Reporte</div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <div class="loading-spinner"></div>
            <h3>Generando su reporte personalizado...</h3>
            <p>Por favor espere mientras procesamos su informaci√≥n</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state" style="display: none;">
            <h3>‚ùå Error al cargar el reporte</h3>
            <p id="errorMessage">Ha ocurrido un error inesperado.</p>
            <button class="btn btn-primary" onclick="location.reload()">üîÑ Reintentar</button>
        </div>

        <!-- Main Report Container -->
        <div class="reporte-container" id="reportContainer" style="display: none;">
            <div class="report-header">
                <div class="report-title">Reporte M√©dico Personalizado</div>
                <div class="report-subtitle">Protocolo Integral de Vitiligo</div>
                <div class="report-date" id="reportDate">Generado el: --</div>
            </div>

            <!-- Patient Summary Section -->
            <div class="section">
                <h3 class="section-title">
                    <span class="section-icon">üë§</span>
                    Resumen del Paciente
                </h3>
                
                <div class="patient-summary" id="patientSummary">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Content sections will be populated dynamically -->
            <div id="dynamicContent">
                <!-- Additional sections will be added here -->
            </div>

            <!-- Contact Section -->
            <div class="contact-section">
                <div class="contact-title">¬øListo para Comenzar su Tratamiento?</div>
                <p style="margin-bottom: 30px;">El Dr. Jos√© Moya y su equipo est√°n listos para acompa√±arlo en su proceso de recuperaci√≥n</p>
                
                <div class="contact-info">
                    <div class="contact-method">
                        <div class="contact-icon">üìß</div>
                        <div class="contact-details">Email</div>
                        <div>info@drmoya.com</div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">Respuesta en 24 horas</div>
                    </div>
                    <div class="contact-method">
                        <div class="contact-icon">üì±</div>
                        <div class="contact-details">WhatsApp</div>
                        <div>+1 (305) 555-0123</div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">Consultas r√°pidas</div>
                    </div>
                    <div class="contact-method">
                        <div class="contact-icon">üè•</div>
                        <div class="contact-details">Consulta Presencial</div>
                        <div>Miami, Florida</div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">Cita previa requerida</div>
                    </div>
                    <div class="contact-method">
                        <div class="contact-icon">üíª</div>
                        <div class="contact-details">Consulta Virtual</div>
                        <div>Zoom/Telemedicina</div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">Disponible mundialmente</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="actions print-hidden">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">Acciones Disponibles</h3>
                <button class="btn btn-success" onclick="scheduleConsultation()" id="btnSchedule">üìÖ Agendar Consulta</button>
                <button class="btn btn-primary" onclick="downloadPDF()" id="btnPDF">üìÑ Descargar PDF</button>
                <button class="btn btn-info" onclick="sendByEmail()" id="btnEmail">üìß Enviar por Email</button>
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir Reporte</button>
                <button class="btn btn-info" onclick="saveToCloud()" id="btnSave">‚òÅÔ∏è Guardar en la Nube</button>
            </div>

            <!-- Important Alerts -->
            <div id="importantAlerts">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-content">
                <h3>Dr. Jos√© Moya - Especialista en Vitiligo</h3>
                <p>40 a√±os de experiencia en medicina especializada</p>
                <div class="disclaimer">
                    <strong>Aviso M√©dico:</strong> Este reporte es una evaluaci√≥n preliminar basada en la informaci√≥n proporcionada. 
                    No sustituye una consulta m√©dica presencial. Para un diagn√≥stico definitivo y plan de tratamiento, 
                    es necesaria una evaluaci√≥n cl√≠nica completa. Todos los tratamientos deben ser supervisados por un profesional m√©dico calificado.
                </div>
                <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.7;">
                    ¬© 2025 Dr. Jos√© Moya. Protocolo de Vitiligo. Todos los derechos reservados.
                </div>
            </div>
        </div>
    </div>

    <script>
        let reportData = {};
        let allPatientData = {};
        let currentEvaluationId = null;
        let currentReportId = null;

        // API Base URL
        const API_BASE = '/pidasalud/protocolo-vitiligo/api.php';

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initializeReport();
        });

        // Inicializar reporte
        async function initializeReport() {
            try {
                showLoadingState();
                
                // Verificar si hay datos en localStorage como fallback
                const localData = getLocalStorageData();
                
                if (localData && Object.keys(localData).length > 0) {
                    // Usar datos locales si est√°n disponibles
                    allPatientData = localData;
                    await generateReportFromData();
                } else {
                    // Intentar cargar desde el servidor
                    await loadDataFromServer();
                }
                
            } catch (error) {
                console.error('Error inicializando reporte:', error);
                showErrorState('Error al cargar los datos del reporte. ' + error.message);
            }
        }

        // Mostrar estado de carga
        function showLoadingState() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'none';
        }

        // Mostrar estado de error
        function showErrorState(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('reportContainer').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }

        // Mostrar reporte
        function showReport() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'block';
        }

        // Obtener datos de localStorage como fallback
        function getLocalStorageData() {
            try {
                const combinedData = localStorage.getItem('reporteCompleto');
                if (combinedData) {
                    return JSON.parse(combinedData);
                }
                
                // Cargar datos individuales como √∫ltimo recurso
                return {
                    datosBasicos: JSON.parse(localStorage.getItem('datosBasicos') || '{}'),
                    fitzpatrick: JSON.parse(localStorage.getItem('fitzpatrickData') || '{}'),
                    antecedentes: JSON.parse(localStorage.getItem('antecedentesData') || '{}'),
                    vitiligoActual: JSON.parse(localStorage.getItem('vitiligoActualData') || '{}'),
                    capacidadInversion: JSON.parse(localStorage.getItem('capacidadInversionData') || '{}')
                };
            } catch (error) {
                console.error('Error cargando datos locales:', error);
                return {};
            }
        }

        // Cargar datos desde el servidor
        async function loadDataFromServer() {
            try {
                const response = await fetch(`${API_BASE}/evaluacion/cargar`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('No se pudieron cargar los datos del servidor');
                }

                const result = await response.json();
                
                if (result.success) {
                    allPatientData = result.evaluacion;
                    currentEvaluationId = result.evaluacion.evaluacion.id;
                    await generateReportFromData();
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
                
            } catch (error) {
                // Si falla el servidor, intentar con datos locales
                const localData = getLocalStorageData();
                if (localData && Object.keys(localData).length > 0) {
                    allPatientData = localData;
                    await generateReportFromData();
                    showAlert('Datos cargados desde cache local. Algunos datos podr√≠an no estar actualizados.', 'warning');
                } else {
                    throw error;
                }
            }
        }

        // Generar reporte desde los datos
        async function generateReportFromData() {
            try {
                // Generar reporte en el servidor si es posible
                await generateServerReport();
                
                // Generar contenido del reporte
                setReportDate();
                generatePatientSummary();
                generateAllSections();
                generateAlerts();
                
                showReport();
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                // Continuar con generaci√≥n local
                setReportDate();
                generatePatientSummary();
                generateAllSections();
                generateAlerts();
                showReport();
            }
        }

        // Generar reporte en el servidor
        async function generateServerReport() {
            try {
                const response = await fetch(`${API_BASE}/reporte/generar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        evaluacion_id: currentEvaluationId
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentReportId = result.reporte_id;
                        if (result.datos) {
                            allPatientData = result.datos;
                        }
                    }
                }
            } catch (error) {
                console.log('Reporte del servidor no disponible, usando datos locales');
            }
        }

        // Establecer fecha del reporte
        function setReportDate() {
            const now = new Date();
            const dateString = now.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('reportDate').textContent = `Generado el: ${dateString}`;
        }

        // Generar resumen del paciente
        function generatePatientSummary() {
            const datos = allPatientData.datosBasicos || allPatientData.datos_basicos || {};
            const capacidad = allPatientData.capacidadInversion || allPatientData.capacidad_inversion || {};
            const vitiligo = allPatientData.vitiligoActual || allPatientData.vitiligo_actual || {};
            
            const summaryHtml = `
                <div class="summary-card">
                    <div class="card-title">Informaci√≥n Personal</div>
                    <div class="card-content">
                        <strong>Nombre:</strong> ${datos.nombre || 'No especificado'}<br>
                        <strong>Edad:</strong> ${datos.edad || 'No especificado'} a√±os<br>
                        <strong>Sexo:</strong> ${datos.sexo || 'No especificado'}<br>
                        <strong>Pa√≠s:</strong> ${capacidad.pais_residencia || datos.pais || 'No especificado'}<br>
                        <strong>Email:</strong> ${datos.email || 'No especificado'}
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-title">Tiempo con Vitiligo</div>
                    <div class="card-content">
                        <strong>Inicio:</strong> ${getTimeDescription(vitiligo.tiempo_inicio)}<br>
                        <strong>Progresi√≥n:</strong> ${getProgressionDescription(vitiligo.progresion_selected || vitiligo.progresion)}<br>
                        <strong>VASI Total:</strong> ${vitiligo.vasi_total || 'No calculado'}<br>
                        <strong>DLQI:</strong> ${getTotalDLQI(vitiligo)} / 30
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-title">Capacidad de Inversi√≥n</div>
                    <div class="card-content">
                        <strong>Nivel:</strong> ${getInvestmentLevelDescription(calculateInvestmentLevel())}<br>
                        <strong>Disponible Inmediato:</strong> ${getAmountDescription(capacidad.monto_disponible_inmediato)}<br>
                        <strong>Mensual Sostenible:</strong> ${getAmountDescription(capacidad.monto_mensual_sostenible)}<br>
                        <strong>Prioridad:</strong> ${getPriorityDescription(capacidad.prioridad_tratamiento)}
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-title">Estado del Tratamiento</div>
                    <div class="card-content">
                        <strong>Evaluaci√≥n:</strong> Completada ‚úÖ<br>
                        <strong>Reporte:</strong> Generado ‚úÖ<br>
                        <strong>Siguiente Paso:</strong> Agendar consulta<br>
                        <strong>Urgencia:</strong> ${getUrgencyLevel(capacidad.prioridad_tratamiento)}
                    </div>
                </div>
            `;
            
            document.getElementById('patientSummary').innerHTML = summaryHtml;
        }

        // Generar todas las secciones del reporte
        function generateAllSections() {
            const dynamicContent = document.getElementById('dynamicContent');
            
            // Aqu√≠ se agregar√≠an todas las secciones adicionales del reporte
            // Por ejemplo: Fitzpatrick, evaluaci√≥n de riesgo, plan de tratamiento, etc.
            
            const sectionsHtml = `
                <!-- Evaluaci√≥n Fitzpatrick -->
                <div class="section">
                    <h3 class="section-title">
                        <span class="section-icon">‚òÄÔ∏è</span>
                        Fototipo de Piel (Fitzpatrick)
                    </h3>
                    ${generateFitzpatrickSection()}
                </div>

                <!-- Plan de Tratamiento -->
                <div class="treatment-plan">
                    ${generateTreatmentPlan()}
                </div>

                <!-- Desglose de Inversi√≥n -->
                <div class="investment-breakdown">
                    ${generateInvestmentBreakdown()}
                </div>
            `;
            
            dynamicContent.innerHTML = sectionsHtml;
        }

        // Generar secci√≥n de Fitzpatrick
        function generateFitzpatrickSection() {
            const fitzpatrick = allPatientData.fitzpatrick || allPatientData.fitzpatrick_data || {};
            const fitzType = fitzpatrick.fitzpatrick_type || fitzpatrick.fitzpatrick || 'No evaluado';
            
            return `
                <div class="patient-summary">
                    <div class="summary-card">
                        <div class="card-title">Fototipo Determinado</div>
                        <div class="card-content">
                            <strong>Tipo:</strong> ${fitzType}<br>
                            <strong>Descripci√≥n:</strong> ${getFitzpatrickDescription(fitzType)}
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="card-title">Protocolo Recomendado</div>
                        <div class="card-content">
                            ${getFitzpatrickProtocol(fitzType)}
                        </div>
                    </div>
                </div>
            `;
        }

        // Generar plan de tratamiento
        function generateTreatmentPlan() {
            const investmentLevel = calculateInvestmentLevel();
            const planData = getTreatmentPlanData(investmentLevel);
            
            return `
                <div class="plan-title">${planData.title}</div>
                <div class="plan-details">
                    <div class="plan-section">
                        <h4>üè• Consultas y Evaluaci√≥n</h4>
                        <ul>
                            ${planData.consultations.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="plan-section">
                        <h4>üíä Tratamientos Incluidos</h4>
                        <ul>
                            ${planData.treatments.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="plan-section">
                        <h4>üî¨ Estudios y An√°lisis</h4>
                        <ul>
                            ${planData.studies.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="plan-section">
                        <h4>üìÖ Seguimiento</h4>
                        <ul>
                            ${planData.followUp.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        // Generar desglose de inversi√≥n
        function generateInvestmentBreakdown() {
            const investmentLevel = calculateInvestmentLevel();
            const costs = getInvestmentCosts(investmentLevel);
            
            return `
                <div class="investment-title">üí∞ Desglose de Inversi√≥n Estimada</div>
                <div class="cost-grid">
                    <div class="cost-item">
                        <div class="cost-amount">${costs.initial}</div>
                        <div class="cost-description">Inversi√≥n Inicial</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-amount">${costs.monthly}</div>
                        <div class="cost-description">Costo Mensual</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-amount">${costs.sixMonths}</div>
                        <div class="cost-description">Total 6 Meses</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-amount">${costs.yearly}</div>
                        <div class="cost-description">Total Anual</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px; opacity: 0.9;">
                    <strong>Opciones de Financiamiento:</strong> ${costs.financing}
                </div>
            `;
        }

        // Generar alertas importantes
        function generateAlerts() {
            const alerts = getImportantAlerts();
            
            if (alerts.length > 0) {
                const html = alerts.map(alert => `
                    <div class="alert alert-${alert.type}">
                        <strong>${alert.title}</strong><br>
                        ${alert.message}
                    </div>
                `).join('');
                
                document.getElementById('importantAlerts').innerHTML = html;
            }
        }

        // Funciones de acci√≥n mejoradas
        async function scheduleConsultation() {
            const btn = document.getElementById('btnSchedule');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Procesando...';
                
                const datos = allPatientData.datosBasicos || allPatientData.datos_basicos || {};
                const message = `Hola Dr. Moya, he completado la evaluaci√≥n de Vitiligo y me gustar√≠a agendar una consulta.

Mis datos:
- Nombre: ${datos.nombre || 'No especificado'}
- Email: ${datos.email || 'No especificado'}
- Pa√≠s: ${(allPatientData.capacidadInversion || allPatientData.capacidad_inversion || {}).pais_residencia || 'No especificado'}
- ID de Evaluaci√≥n: ${currentEvaluationId || 'Local'}

¬øCu√°ndo podr√≠amos programar la primera consulta?`;

                const encodedMessage = encodeURIComponent(message);
                window.open(`https://wa.me/13055550123?text=${encodedMessage}`, '_blank');
                
                showAlert('Redirigiendo a WhatsApp...', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al abrir WhatsApp', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function downloadPDF() {
            const btn = document.getElementById('btnPDF');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Generando PDF...';
                
                if (currentReportId) {
                    // Intentar generar PDF en el servidor
                    const response = await fetch(`${API_BASE}/reporte/pdf?reporte_id=${currentReportId}`, {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.pdf_url) {
                            window.open(result.pdf_url, '_blank');
                            showAlert('PDF generado exitosamente', 'success');
                            return;
                        }
                    }
                }
                
                // Fallback: usar impresi√≥n del navegador
                window.print();
                showAlert('Use Ctrl+P o Cmd+P para guardar como PDF', 'info');
                
            } catch (error) {
                console.error('Error:', error);
                window.print();
                showAlert('Fallback: Use la funci√≥n de impresi√≥n', 'warning');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function sendByEmail() {
            const btn = document.getElementById('btnEmail');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Enviando...';
                
                if (currentReportId) {
                    // Intentar env√≠o desde el servidor
                    const response = await fetch(`${API_BASE}/reporte/enviar-email`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            reporte_id: currentReportId
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            showAlert('Reporte enviado por email exitosamente', 'success');
                            return;
                        }
                    }
                }
                
                // Fallback: abrir cliente de email
                const datos = allPatientData.datosBasicos || allPatientData.datos_basicos || {};
                const subject = `Reporte de Evaluaci√≥n Vitiligo - ${datos.nombre || 'Paciente'}`;
                const body = `Adjunto mi reporte completo de evaluaci√≥n de Vitiligo.

Por favor revise y confirme recepci√≥n para proceder con el agendamiento de consulta.

ID de Evaluaci√≥n: ${currentEvaluationId || 'Local'}

Saludos cordiales.`;

                window.open(`mailto:info@drmoya.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
                showAlert('Cliente de email abierto', 'info');
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al enviar email', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function saveToCloud() {
            const btn = document.getElementById('btnSave');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Guardando...';
                
                // Intentar guardar en el servidor
                const response = await fetch(`${API_BASE}/evaluacion/guardar-paso`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        paso: 'reporte_completo',
                        datos: allPatientData
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showAlert('Datos guardados en la nube exitosamente', 'success');
                        return;
                    }
                }
                
                // Fallback: guardar en localStorage
                localStorage.setItem('reporteCompleto', JSON.stringify(allPatientData));
                localStorage.setItem('reporteFecha', new Date().toISOString());
                showAlert('Datos guardados localmente como respaldo', 'warning');
                
            } catch (error) {
                console.error('Error:', error);
                localStorage.setItem('reporteCompleto', JSON.stringify(allPatientData));
                showAlert('Error del servidor - datos guardados localmente', 'warning');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Funciones auxiliares (mantener las existentes y agregar nuevas)
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '400px';
            alertDiv.innerHTML = message;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Funciones auxiliares para datos (mantener todas las existentes)
        function getTimeDescription(time) {
            const descriptions = {
                'menos_3m': 'Menos de 3 meses',
                '3m_6m': '3 a 6 meses',
                '6m_1a': '6 meses a 1 a√±o',
                '1a_2a': '1 a 2 a√±os',
                '2a_5a': '2 a 5 a√±os',
                '5a_10a': '5 a 10 a√±os',
                'mas_10a': 'M√°s de 10 a√±os'
            };
            return descriptions[time] || 'No especificado';
        }

        function getProgressionDescription(progression) {
            const descriptions = {
                'estable': 'Estable (sin crecimiento)',
                'lenta': 'Progresi√≥n lenta',
                'rapida': 'Progresi√≥n r√°pida'
            };
            return descriptions[progression] || 'No especificado';
        }

        function getTotalDLQI(vitiligo) {
            if (vitiligo.dlqiScores || vitiligo.dlqi_scores) {
                const scores = vitiligo.dlqiScores || vitiligo.dlqi_scores;
                return Object.values(scores).reduce((sum, score) => sum + (parseInt(score) || 0), 0);
            }
            return vitiligo.dlqi_total || '0';
        }

        function calculateInvestmentLevel() {
            const capacidad = allPatientData.capacidadInversion || allPatientData.capacidad_inversion || {};
            let score = 0;

            const monthly = capacidad.monto_mensual_sostenible;
            if (monthly === 'mas_3000' || monthly === '2000_3000') score += 3;
            else if (monthly === '1000_2000' || monthly === '500_1000') score += 2;
            else if (monthly === '200_500') score += 1;

            const immediate = capacidad.monto_disponible_inmediato;
            if (immediate === 'mas_10000' || immediate === '5000_10000') score += 3;
            else if (immediate === '2500_5000' || immediate === '1000_2500') score += 2;
            else if (immediate === '500_1000') score += 1;

            if (score >= 5) return 3; // Premium
            else if (score >= 3) return 2; // Integral
            else return 1; // Esencial
        }

        function getInvestmentLevelDescription(level) {
            const descriptions = {
                1: 'Esencial - Presupuesto Limitado',
                2: 'Integral - Inversi√≥n Moderada',
                3: 'Premium - Inversi√≥n Completa'
            };
            return descriptions[level];
        }

        function getAmountDescription(amount) {
            const descriptions = {
                '0_100': '$0 - $100',
                '100_300': '$100 - $300',
                '300_500': '$300 - $500',
                '500_1000': '$500 - $1,000',
                '1000_2500': '$1,000 - $2,500',
                '2500_5000': '$2,500 - $5,000',
                '5000_10000': '$5,000 - $10,000',
                'mas_10000': 'M√°s de $10,000',
                '0_50': '$0 - $50',
                '50_100': '$50 - $100',
                '100_200': '$100 - $200',
                '200_500': '$200 - $500',
                '500_1000': '$500 - $1,000',
                '1000_2000': '$1,000 - $2,000',
                '2000_3000': '$2,000 - $3,000',
                'mas_3000': 'M√°s de $3,000'
            };
            return descriptions[amount] || 'No especificado';
        }

        function getPriorityDescription(priority) {
            const descriptions = {
                'baja': 'Baja prioridad',
                'media': 'Prioridad media',
                'alta': 'Alta prioridad',
                'urgente': 'Urgente'
            };
            return descriptions[priority] || 'No especificado';
        }

        function getUrgencyLevel(priority) {
            const levels = {
                'baja': 'üü¢ Baja',
                'media': 'üü° Media',
                'alta': 'üü† Alta',
                'urgente': 'üî¥ Urgente'
            };
            return levels[priority] || '‚ö™ No especificado';
        }

        function getFitzpatrickDescription(type) {
            const descriptions = {
                1: 'Piel muy clara, siempre se quema, nunca se broncea',
                2: 'Piel clara, se quema f√°cilmente, se broncea m√≠nimamente',
                3: 'Piel intermedia, se quema moderadamente, se broncea gradualmente',
                4: 'Piel morena clara, se quema m√≠nimamente, se broncea bien',
                5: 'Piel morena, raramente se quema, se broncea profusamente',
                6: 'Piel negra, nunca se quema, se pigmenta profusamente'
            };
            return descriptions[type] || 'No evaluado';
        }

        function getFitzpatrickProtocol(type) {
            const protocols = {
                1: 'Dosis inicial UVB-NB: 280-300 mJ/cm¬≤, incrementos 10%, protecci√≥n SPF 50+',
                2: 'Dosis inicial UVB-NB: 300-350 mJ/cm¬≤, incrementos 15%, protecci√≥n SPF 30-50+',
                3: 'Dosis inicial UVB-NB: 440-500 mJ/cm¬≤, incrementos 15-20%, candidato ideal para terapias combinadas',
                4: 'Dosis inicial UVB-NB: 500-600 mJ/cm¬≤, incrementos 20%, menor riesgo de fotosensibilidad',
                5: 'Dosis inicial UVB-NB: 650-800 mJ/cm¬≤, incrementos 20-25%, protocolo intensivo recomendado',
                6: 'Dosis inicial UVB-NB: 800-1000 mJ/cm¬≤, incrementos 25%, protocolo multimodal agresivo'
            };
            return protocols[type] || 'Evaluaci√≥n requerida para determinar protocolo espec√≠fico';
        }

        function getTreatmentPlanData(level) {
            const plans = {
                1: {
                    title: 'üî¥ Plan Esencial - Protocolo B√°sico Efectivo',
                    consultations: [
                        'Consulta virtual inicial completa (90 min)',
                        'Evaluaci√≥n dermatol√≥gica especializada',
                        'An√°lisis fotogr√°fico digital',
                        'Seguimiento mensual virtual (30 min)'
                    ],
                    treatments: [
                        'Protocolo b√°sico con suplementos esenciales',
                        'Fototerapia UVB-NB casera supervisada',
                        'Corticoides t√≥picos especializados',
                        'Vitaminas y antioxidantes espec√≠ficos'
                    ],
                    studies: [
                        'Perfil tiroideo b√°sico',
                        'Vitamina D y B12',
                        'Hemograma completo',
                        'Fotograf√≠as de seguimiento mensuales'
                    ],
                    followUp: [
                        'Consultas virtuales mensuales',
                        'Ajustes de protocolo seg√∫n evoluci√≥n',
                        'Acceso a grupo de WhatsApp de soporte',
                        'Manual digital completo incluido'
                    ]
                },
                2: {
                    title: 'üü° Plan Integral - Protocolo Avanzado Personalizado',
                    consultations: [
                        'Consulta inicial presencial o virtual premium (120 min)',
                        'Evaluaci√≥n multidisciplinaria completa',
                        'An√°lisis gen√©tico por saliva incluido',
                        'Seguimiento quincenal especializado'
                    ],
                    treatments: [
                        'Protocolo avanzado personalizado',
                        'Fototerapia UVB-NB profesional',
                        'Inhibidores de calcineurina de √∫ltima generaci√≥n',
                        'Medicamentos sist√©micos cuando sea necesario'
                    ],
                    studies: [
                        'Panel gen√©tico completo para Vitiligo',
                        'Perfil autoinmune especializado',
                        'Screening de tuberculosis para biol√≥gicos',
                        'Laboratorios especializados cada 3 meses'
                    ],
                    followUp: [
                        'Consultas quincenales primeros 3 meses',
                        'Acceso VIP a consultas de emergencia',
                        'Coordinaci√≥n con especialistas adicionales',
                        'Plan familiar preventivo incluido'
                    ]
                },
                3: {
                    title: 'üü¢ Plan Premium - Protocolo Completo VIP',
                    consultations: [
                        'Consulta presencial en Miami (d√≠a completo)',
                        'Evaluaci√≥n integral con equipo multidisciplinario',
                        'Segunda opini√≥n internacional incluida',
                        'Seguimiento semanal personalizado'
                    ],
                    treatments: [
                        'Protocolo completo con todos los tratamientos disponibles',
                        'Tratamientos biol√≥gicos de √∫ltima generaci√≥n',
                        'Terapias experimentales aprobadas',
                        'Microinjertos y cirug√≠a cuando sea apropiado'
                    ],
                    studies: [
                        'An√°lisis gen√©tico completo familiar',
                        'Estudios de investigaci√≥n participativos',
                        'Monitoreo de biomarcadores avanzados',
                        'Laboratorios mensuales completos'
                    ],
                    followUp: [
                        'Acceso directo 24/7 al Dr. Moya',
                        'Coordinaci√≥n con centros internacionales',
                        'Seguimiento de por vida con descuentos',
                        'Garant√≠a de resultados premium'
                    ]
                }
            };
            return plans[level];
        }

        function getInvestmentCosts(level) {
            const costs = {
                1: {
                    initial: '500',
                    monthly: '350',
                    sixMonths: '2,600',
                    yearly: '4,700',
                    financing: 'Plan de pagos 6 cuotas sin intereses'
                },
                2: {
                    initial: '1,200',
                    monthly: '850',
                    sixMonths: '6,300',
                    yearly: '11,400',
                    financing: 'Financiamiento hasta 12 meses, seguro m√©dico aplicable'
                },
                3: {
                    initial: '2,500',
                    monthly: '2,000',
                    sixMonths: '14,500',
                    yearly: '26,500',
                    financing: 'Planes de financiamiento personalizados, coordinaci√≥n con seguros internacionales'
                }
            };
            return costs[level];
        }

        function getImportantAlerts() {
            const alerts = [];
            const vitiligo = allPatientData.vitiligoActual || allPatientData.vitiligo_actual || {};
            const capacidad = allPatientData.capacidadInversion || allPatientData.capacidad_inversion || {};
            
            // Alerta por progresi√≥n r√°pida
            if (vitiligo.progresion === 'rapida' || vitiligo.progresion_selected === 'rapida') {
                alerts.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Progresi√≥n R√°pida Detectada',
                    message: 'Su Vitiligo muestra progresi√≥n r√°pida. Se recomienda iniciar tratamiento inmediatamente para prevenir mayor extensi√≥n.'
                });
            }

            // Alerta por VASI alto
            const vasi = parseFloat(vitiligo.vasi_total || 0);
            if (vasi > 25) {
                alerts.push({
                    type: 'warning',
                    title: 'üîç Vitiligo Extenso',
                    message: 'Su √≠ndice VASI indica Vitiligo extenso. El tratamiento temprano es crucial para mejores resultados.'
                });
            }

            // Alerta por DLQI alto
            const dlqi = getTotalDLQI(vitiligo);
            if (dlqi > 15) {
                alerts.push({
                    type: 'info',
                    title: 'üíô Impacto en Calidad de Vida',
                    message: 'Su puntuaci√≥n DLQI indica impacto significativo en calidad de vida. Considere apoyo psicol√≥gico complementario.'
                });
            }

            // Alerta por prioridad urgente
            if (capacidad.prioridad_tratamiento === 'urgente') {
                alerts.push({
                    type: 'error',
                    title: 'üö® Tratamiento Urgente',
                    message: 'Ha indicado que el tratamiento es urgente. Recomendamos agendar consulta inmediatamente.'
                });
            }

            // Alerta positiva
            alerts.push({
                type: 'success',
                title: '‚úÖ Evaluaci√≥n Completa Finalizada',
                message: 'Ha completado exitosamente la evaluaci√≥n integral. Ahora tiene un plan personalizado basado en evidencia cient√≠fica.'
            });

            return alerts;
        }
    </script>
</body>
</html>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 300;
        }

        .header h2 {
            color: #3498db;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
            max-width: 800px;
            margin: 0 auto;
        }

        .progress-bar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress {
            width: 100%;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 83.33%;
            transition: width 0.3s ease;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px 5px;
            border-radius: 5px;
            margin: 0 2px;
            background: #ecf0f1;
            color: #7f8c8d;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .step.completed {
            background: #27ae60;
            color: white;
        }

        .step.active {
            background: #3498db;
            color: white;
        }

        .inversion-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 25px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            text-align: center;
        }

        .subsection {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }

        .subsection-title {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52,152,219,0.1);
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #e74c3c;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 0.9em;
            display: none;
        }

        .field-error {
            border-color: #e74c3c !important;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.3) !important;
        }

        .field-success {
            border-color: #27ae60 !important;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.3) !important;
        }

        .validation-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .validation-icon.success {
            color: #27ae60;
        }

        .validation-icon.error {
            color: #e74c3c;
        }

        .error-summary {
            background: #f8d7da;
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .error-summary h4 {
            color: #e74c3c;
            margin-bottom: 15px;
        }

        .error-list {
            list-style: none;
            padding: 0;
        }

        .error-list li {
            padding: 5px 0;
            border-bottom: 1px solid #e74c3c;
            position: relative;
            padding-left: 25px;
        }

        .error-list li:before {
            content: "‚ö†Ô∏è";
            position: absolute;
            left: 0;
        }

        .success-message {
            background: #d4edda;
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #155724;
            display: none;
        }

        .income-calculator {
            background: linear-gradient(135deg, #d5f4e6, #ffffff);
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .calculator-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .income-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .income-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
        }

        .income-item label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .income-item input {
            font-size: 16px;
            text-align: right;
            padding: 8px;
        }

        .currency-prefix {
            position: relative;
        }

        .currency-prefix::before {
            content: '$';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-weight: 600;
        }

        .currency-prefix input {
            padding-left: 25px;
        }

        .summary-box {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
        }

        .investment-levels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .investment-card {
            background: white;
            border: 3px solid #ecf0f1;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .investment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .investment-card.selected {
            border-color: #27ae60;
            background: linear-gradient(135deg, #d5f4e6, #ffffff);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(39,174,96,0.2);
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 12px 18px;
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .radio-item:hover {
            border-color: #3498db;
            background: #f0f8ff;
            transform: translateY(-2px);
        }

        .radio-item.selected {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .radio-item input[type="radio"] {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            border-color: #3498db;
            background: #f0f8ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .checkbox-item.checked {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 12px;
            margin-top: 3px;
            transform: scale(1.3);
        }

        .checkbox-content {
            flex: 1;
        }

        .checkbox-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .checkbox-description {
            font-size: 0.9em;
            color: #7f8c8d;
            line-height: 1.4;
        }

        .priority-scale {
            display: flex;
            justify-content: space-between;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #ecf0f1;
        }

        .priority-level {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            margin: 0 5px;
            position: relative;
        }

        .priority-level:hover {
            transform: translateY(-2px);
        }

        .priority-level.low {
            background: #d5f4e6;
            border: 2px solid #27ae60;
        }

        .priority-level.medium {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .priority-level.high {
            background: #ffeaa7;
            border: 2px solid #fdcb6e;
        }

        .priority-level.urgent {
            background: #fab1a0;
            border: 2px solid #e17055;
        }

        .priority-level.selected {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .financial-timeline {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .timeline-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .timeline-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .timeline-option {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeline-option:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .timeline-option.selected {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.8);
            transform: translateY(-2px);
        }

        .travel-assessment {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .insurance-calculator {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .recommendation-preview {
            background: linear-gradient(135deg, #e8f6fd, #ffffff);
            border: 2px solid #3498db;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .recommendation-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .recommendation-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #3498db;
            text-align: left;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(149,165,166,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39,174,96,0.3);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-confidential {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .inversion-container {
                padding: 20px;
            }
            
            .investment-levels {
                grid-template-columns: 1fr;
            }
            
            .income-grid {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .priority-scale {
                flex-direction: column;
                gap: 10px;
            }
            
            .priority-level {
                margin: 0;
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }

            .checkbox-grid {
                grid-template-columns: 1fr;
            }

            .timeline-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Evaluaci√≥n de Capacidad de Inversi√≥n</h1>
            <h2>Protocolo de Vitiligo - Dr. Jos√© Moya</h2>
            <p>Una evaluaci√≥n honesta y detallada de su capacidad de inversi√≥n nos permite recomendar el plan de tratamiento m√°s apropiado para su situaci√≥n espec√≠fica, asegurando resultados √≥ptimos dentro de sus posibilidades.</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress">
                <div class="progress-fill"></div>
            </div>
            <div class="step-indicator">
                <div class="step completed">Datos B√°sicos</div>
                <div class="step completed">Fitzpatrick</div>
                <div class="step completed">Antecedentes</div>
                <div class="step completed">Vitiligo Actual</div>
                <div class="step active">Capacidad Inversi√≥n</div>
                <div class="step">Reporte</div>
            </div>
        </div>

        <!-- Main Container -->
        <div class="inversion-container">
            <h2 class="section-title">Evaluaci√≥n Financiera Personalizada</h2>
            
            <div class="alert alert-confidential">
                <strong>üîí Informaci√≥n Estrictamente Confidencial:</strong> Toda la informaci√≥n financiera que proporcione est√° protegida por el secreto m√©dico y ser√° utilizada √∫nicamente para personalizar su plan de tratamiento. Sus datos nunca ser√°n compartidos con terceros.
            </div>

            <!-- Secci√≥n: Situaci√≥n Econ√≥mica Actual -->
            <div class="subsection">
                <h3 class="subsection-title">üí∞ Situaci√≥n Econ√≥mica Actual</h3>
                
                <div class="income-calculator">
                    <div class="calculator-title">üìä Calculadora de Ingresos y Gastos</div>
                    
                    <div class="form-group">
                        <label for="pais_residencia">Pa√≠s de Residencia *</label>
                        <select id="pais_residencia" required>
                            <option value="">Seleccione su pa√≠s...</option>
                            <option value="usa">Estados Unidos</option>
                            <option value="canada">Canad√°</option>
                            <option value="mexico">M√©xico</option>
                            <option value="guatemala">Guatemala</option>
                            <option value="honduras">Honduras</option>
                            <option value="el_salvador">El Salvador</option>
                            <option value="nicaragua">Nicaragua</option>
                            <option value="costa_rica">Costa Rica</option>
                            <option value="panama">Panam√°</option>
                            <option value="colombia">Colombia</option>
                            <option value="venezuela">Venezuela</option>
                            <option value="ecuador">Ecuador</option>
                            <option value="peru">Per√∫</option>
                            <option value="bolivia">Bolivia</option>
                            <option value="chile">Chile</option>
                            <option value="argentina">Argentina</option>
                            <option value="uruguay">Uruguay</option>
                            <option value="paraguay">Paraguay</option>
                            <option value="brasil">Brasil</option>
                            <option value="espana">Espa√±a</option>
                            <option value="francia">Francia</option>
                            <option value="italia">Italia</option>
                            <option value="alemania">Alemania</option>
                            <option value="reino_unido">Reino Unido</option>
                            <option value="otro">Otro pa√≠s</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="moneda_local">Moneda de sus ingresos *</label>
                        <select id="moneda_local" required>
                            <option value="">Seleccione...</option>
                            <option value="usd">USD - D√≥lar Estadounidense</option>
                            <option value="eur">EUR - Euro</option>
                            <option value="mxn">MXN - Peso Mexicano</option>
                            <option value="cop">COP - Peso Colombiano</option>
                            <option value="ars">ARS - Peso Argentino</option>
                            <option value="clp">CLP - Peso Chileno</option>
                            <option value="pen">PEN - Sol Peruano</option>
                            <option value="brl">BRL - Real Brasile√±o</option>
                            <option value="cad">CAD - D√≥lar Canadiense</option>
                            <option value="gbp">GBP - Libra Esterlina</option>
                            <option value="otro">Otra moneda</option>
                        </select>
                    </div>

                    <h4 style="color: #27ae60; margin: 20px 0 15px 0;">üìà Ingresos Mensuales</h4>
                    <div class="income-grid">
                        <div class="income-item">
                            <label>Ingresos por Trabajo Principal</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_trabajo" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Ingresos por Trabajo Secundario</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_secundario" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Ingresos por Inversiones/Rentas</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_inversiones" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Pensiones/Jubilaci√≥n</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_pension" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Otros Ingresos</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_otros" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Ingresos Familiares (C√≥nyuge)</label>
                            <div class="currency-prefix">
                                <input type="number" id="ingreso_conyuge" placeholder="0" min="0" step="100">
                            </div>
                        </div>
                    </div>

                    <h4 style="color: #e74c3c; margin: 20px 0 15px 0;">üìâ Gastos Mensuales Fijos</h4>
                    <div class="income-grid">
                        <div class="income-item">
                            <label>Vivienda (Alquiler/Hipoteca)</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_vivienda" placeholder="0" min="0" step="50">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Alimentaci√≥n</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_alimentacion" placeholder="0" min="0" step="50">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Transporte</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_transporte" placeholder="0" min="0" step="50">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Servicios (Agua, Luz, Internet)</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_servicios" placeholder="0" min="0" step="25">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Seguros</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_seguros" placeholder="0" min="0" step="25">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Deudas/Pr√©stamos</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_deudas" placeholder="0" min="0" step="50">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Educaci√≥n</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_educacion" placeholder="0" min="0" step="25">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Salud (Medicamentos, Consultas)</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_salud_actual" placeholder="0" min="0" step="25">
                            </div>
                        </div>
                        <div class="income-item">
                            <label>Otros Gastos Fijos</label>
                            <div class="currency-prefix">
                                <input type="number" id="gasto_otros" placeholder="0" min="0" step="25">
                            </div>
                        </div>
                    </div>

                    <div class="summary-box">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                            <div>
                                <div style="font-size: 1.1em; margin-bottom: 5px;">Ingresos Totales</div>
                                <div style="font-size: 1.8em; font-weight: bold;">$<span id="total_ingresos">0</span></div>
                            </div>
                            <div>
                                <div style="font-size: 1.1em; margin-bottom: 5px;">Gastos Totales</div>
                                <div style="font-size: 1.8em; font-weight: bold;">$<span id="total_gastos">0</span></div>
                            </div>
                            <div>
                                <div style="font-size: 1.1em; margin-bottom: 5px;">Disponible</div>
                                <div style="font-size: 1.8em; font-weight: bold;" id="disponible_color">$<span id="total_disponible">0</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="estabilidad_ingresos">¬øQu√© tan estables son sus ingresos? *</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="estabilidad_ingresos" value="muy_estable" id="estab_muy_estable">
                            <label for="estab_muy_estable">Muy estables (empleado fijo)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="estabilidad_ingresos" value="estable" id="estab_estable">
                            <label for="estab_estable">Estables (contrato definido)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="estabilidad_ingresos" value="variable" id="estab_variable">
                            <label for="estab_variable">Variables (independiente)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="estabilidad_ingresos" value="inestable" id="estab_inestable">
                            <label for="estab_inestable">Inestables (temporales)</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Recursos Disponibles -->
            <div class="subsection">
                <h3 class="subsection-title">üè¶ Recursos y Ahorros Disponibles</h3>
                
                <div class="form-group">
                    <label>¬øCon qu√© recursos cuenta para invertir en su salud? (Seleccione todos los que apliquen)</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_ahorros">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Ahorros Personales</div>
                                <div class="checkbox-description">Dinero ahorrado espec√≠ficamente para salud o emergencias</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_seguro_salud">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Seguro de Salud</div>
                                <div class="checkbox-description">Cobertura m√©dica privada o estatal</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_apoyo_familiar">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Apoyo Familiar</div>
                                <div class="checkbox-description">Familia dispuesta a ayudar financieramente</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_credito">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Acceso a Cr√©dito</div>
                                <div class="checkbox-description">Tarjetas de cr√©dito, pr√©stamos bancarios</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_inversiones">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Inversiones L√≠quidas</div>
                                <div class="checkbox-description">Acciones, bonos, fondos que puede convertir en efectivo</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_propiedades">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Propiedades/Activos</div>
                                <div class="checkbox-description">Bienes que podr√≠a vender o usar como garant√≠a</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_plan_pagos">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Plan de Pagos</div>
                                <div class="checkbox-description">Prefiere financiamiento en cuotas mensuales</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="recurso_ninguno">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Recursos Muy Limitados</div>
                                <div class="checkbox-description">Solo puedo cubrir gastos b√°sicos mensuales</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="monto_disponible_inmediato">¬øCu√°nto dinero podr√≠a destinar INMEDIATAMENTE para comenzar un tratamiento? *</label>
                    <select id="monto_disponible_inmediato" required>
                        <option value="">Seleccione...</option>
                        <option value="0_100">$0 - $100</option>
                        <option value="100_300">$100 - $300</option>
                        <option value="300_500">$300 - $500</option>
                        <option value="500_1000">$500 - $1,000</option>
                        <option value="1000_2500">$1,000 - $2,500</option>
                        <option value="2500_5000">$2,500 - $5,000</option>
                        <option value="5000_10000">$5,000 - $10,000</option>
                        <option value="mas_10000">M√°s de $10,000</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="monto_mensual_sostenible">¬øCu√°nto podr√≠a destinar MENSUALMENTE de manera sostenible? *</label>
                    <select id="monto_mensual_sostenible" required>
                        <option value="">Seleccione...</option>
                        <option value="0_50">$0 - $50</option>
                        <option value="50_100">$50 - $100</option>
                        <option value="100_200">$100 - $200</option>
                        <option value="200_500">$200 - $500</option>
                        <option value="500_1000">$500 - $1,000</option>
                        <option value="1000_2000">$1,000 - $2,000</option>
                        <option value="2000_3000">$2,000 - $3,000</option>
                        <option value="mas_3000">M√°s de $3,000</option>
                    </select>
                </div>
            </div>

            <!-- Secci√≥n: Evaluaci√≥n de Seguros -->
            <div class="insurance-calculator">
                <h3 style="color: white; margin-bottom: 20px;">üè• Evaluaci√≥n de Cobertura de Seguros</h3>
                
                <div class="form-group">
                    <label style="color: white;">¬øTiene seguro de salud? *</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="tiene_seguro" value="si_privado" id="seguro_si_privado">
                            <label for="seguro_si_privado">S√≠, privado</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="tiene_seguro" value="si_publico" id="seguro_si_publico">
                            <label for="seguro_si_publico">S√≠, p√∫blico</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="tiene_seguro" value="si_ambos" id="seguro_si_ambos">
                            <label for="seguro_si_ambos">Ambos</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="tiene_seguro" value="no" id="seguro_no">
                            <label for="seguro_no">No tengo</label>
                        </div>
                    </div>
                </div>

                <div id="seguro_detalles" style="display: none;">
                    <div class="form-group">
                        <label style="color: white;">¬øSu seguro cubre tratamientos dermatol√≥gicos especializados?</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" name="cobertura_dermatologia" value="si_completa" id="cob_si_completa">
                                <label for="cob_si_completa">S√≠, cobertura completa</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="cobertura_dermatologia" value="si_parcial" id="cob_si_parcial">
                                <label for="cob_si_parcial">S√≠, cobertura parcial</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="cobertura_dermatologia" value="no" id="cob_no">
                                <label for="cob_no">No cubre</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="cobertura_dermatologia" value="no_se" id="cob_no_se">
                                <label for="cob_no_se">No lo s√©</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="deducible_anual" style="color: white;">¬øCu√°l es su deducible anual aproximado?</label>
                        <div class="currency-prefix">
                            <input type="number" id="deducible_anual" placeholder="0" min="0" step="100">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="copago_especialista" style="color: white;">¬øCu√°nto paga por consulta con especialista?</label>
                        <div class="currency-prefix">
                            <input type="number" id="copago_especialista" placeholder="0" min="0" step="10">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Prioridad y Urgencia -->
            <div class="subsection">
                <h3 class="subsection-title">‚è∞ Prioridad y Urgencia del Tratamiento</h3>
                
                <div class="form-group">
                    <label>¬øQu√© tan prioritario es resolver su Vitiligo en este momento? *</label>
                    <div class="priority-scale">
                        <div class="priority-level low" data-value="baja">
                            <div style="font-size: 2em; margin-bottom: 10px;">üòå</div>
                            <div style="font-weight: 600;">Baja Prioridad</div>
                            <div style="font-size: 0.9em; color: #666;">Puedo esperar, no es urgente</div>
                        </div>
                        <div class="priority-level medium" data-value="media">
                            <div style="font-size: 2em; margin-bottom: 10px;">ü§î</div>
                            <div style="font-weight: 600;">Prioridad Media</div>
                            <div style="font-size: 0.9em; color: #666;">Me gustar√≠a tratarlo pronto</div>
                        </div>
                        <div class="priority-level high" data-value="alta">
                            <div style="font-size: 2em; margin-bottom: 10px;">üòü</div>
                            <div style="font-weight: 600;">Alta Prioridad</div>
                            <div style="font-size: 0.9em; color: #666;">Es importante para m√≠</div>
                        </div>
                        <div class="priority-level urgent" data-value="urgente">
                            <div style="font-size: 2em; margin-bottom: 10px;">üò∞</div>
                            <div style="font-weight: 600;">Urgente</div>
                            <div style="font-size: 0.9em; color: #666;">Necesito tratamiento ya</div>
                        </div>
                    </div>
                    <input type="hidden" id="prioridad_tratamiento" required>
                </div>

                <div class="form-group">
                    <label>¬øQu√© factores influyen en la urgencia de su tratamiento? (Seleccione todos los que apliquen)</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_trabajo">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Impacto Laboral</div>
                                <div class="checkbox-description">Afecta mi trabajo o oportunidades profesionales</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_social">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Impacto Social</div>
                                <div class="checkbox-description">Afecta mis relaciones o vida social</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_autoestima">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Autoestima</div>
                                <div class="checkbox-description">Me afecta psicol√≥gicamente de manera significativa</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_progresion">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Progresi√≥n R√°pida</div>
                                <div class="checkbox-description">El Vitiligo est√° creciendo r√°pidamente</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_evento">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Evento Importante</div>
                                <div class="checkbox-description">Tengo un evento importante pr√≥ximamente</div>
                            </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="urgencia_familiar">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Presi√≥n Familiar</div>
                                <div class="checkbox-description">Mi familia insiste en que me trate</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Timeline de Tratamiento -->
            <div class="financial-timeline">
                <h3 class="timeline-title">üìÖ Timeline de Inversi√≥n</h3>
                
                <div class="form-group">
                    <label style="color: white;">¬øEn qu√© plazo le gustar√≠a ver resultados significativos? *</label>
                    <div class="timeline-options">
                        <div class="timeline-option" data-value="3_meses">
                            <div style="font-weight: 600;">3 Meses</div>
                            <div style="font-size: 0.9em;">Resultados r√°pidos</div>
                        </div>
                        <div class="timeline-option" data-value="6_meses">
                            <div style="font-weight: 600;">6 Meses</div>
                            <div style="font-size: 0.9em;">Plazo moderado</div>
                        </div>
                        <div class="timeline-option" data-value="12_meses">
                            <div style="font-weight: 600;">12 Meses</div>
                            <div style="font-size: 0.9em;">Tratamiento completo</div>
                        </div>
                        <div class="timeline-option" data-value="18_meses">
                            <div style="font-weight: 600;">18 Meses</div>
                            <div style="font-size: 0.9em;">Proceso gradual</div>
                        </div>
                        <div class="timeline-option" data-value="mas_18">
                            <div style="font-weight: 600;">+18 Meses</div>
                            <div style="font-size: 0.9em;">Sin prisa</div>
                        </div>
                    </div>
                    <input type="hidden" id="timeline_resultados" required>
                </div>

                <div class="form-group">
                    <label for="presupuesto_total_maximo" style="color: white;">¬øCu√°l ser√≠a su presupuesto total m√°ximo para el tratamiento completo?</label>
                    <select id="presupuesto_total_maximo">
                        <option value="">Seleccione...</option>
                        <option value="0_500">$0 - $500</option>
                        <option value="500_1500">$500 - $1,500</option>
                        <option value="1500_3000">$1,500 - $3,000</option>
                        <option value="3000_5000">$3,000 - $5,000</option>
                        <option value="5000_10000">$5,000 - $10,000</option>
                        <option value="10000_20000">$10,000 - $20,000</option>
                        <option value="20000_50000">$20,000 - $50,000</option>
                        <option value="mas_50000">M√°s de $50,000</option>
                        <option value="sin_limite">Sin l√≠mite espec√≠fico</option>
                    </select>
                </div>
            </div>

            <!-- Secci√≥n: Disposici√≥n para Viajar -->
            <div class="travel-assessment">
                <h3 style="color: white; margin-bottom: 20px;">‚úàÔ∏è Disposici√≥n para Viajar por Tratamiento</h3>
                
                <div class="form-group">
                    <label style="color: white;">¬øEstar√≠a dispuesto/a a viajar para recibir tratamiento especializado? *</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="dispuesto_viajar" value="si_cualquier_lugar" id="viaje_si_cualquier">
                            <label for="viaje_si_cualquier">S√≠, a cualquier lugar</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="dispuesto_viajar" value="si_nacional" id="viaje_si_nacional">
                            <label for="viaje_si_nacional">S√≠, dentro de mi pa√≠s</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="dispuesto_viajar" value="si_regional" id="viaje_si_regional">
                            <label for="viaje_si_regional">S√≠, a pa√≠ses cercanos</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="dispuesto_viajar" value="solo_miami" id="viaje_solo_miami">
                            <label for="viaje_solo_miami">Solo a Miami</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="dispuesto_viajar" value="no" id="viaje_no">
                            <label for="viaje_no">No puedo viajar</label>
                        </div>
                    </div>
                </div>

                <div id="viaje_detalles" style="display: none;">
                    <div class="form-group">
                        <label for="presupuesto_viaje" style="color: white;">¬øCu√°nto podr√≠a destinar para gastos de viaje (transporte + alojamiento)?</label>
                        <select id="presupuesto_viaje">
                            <option value="">Seleccione...</option>
                            <option value="0_500">$0 - $500</option>
                            <option value="500_1000">$500 - $1,000</option>
                            <option value="1000_2000">$1,000 - $2,000</option>
                            <option value="2000_5000">$2,000 - $5,000</option>
                            <option value="5000_10000">$5,000 - $10,000</option>
                            <option value="mas_10000">M√°s de $10,000</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="frecuencia_viajes" style="color: white;">¬øCon qu√© frecuencia podr√≠a viajar para seguimiento?</label>
                        <select id="frecuencia_viajes">
                            <option value="">Seleccione...</option>
                            <option value="mensual">Mensualmente</option>
                            <option value="bimensual">Cada 2 meses</option>
                            <option value="trimestral">Cada 3 meses</option>
                            <option value="semestral">Cada 6 meses</option>
                            <option value="anual">Una vez al a√±o</option>
                            <option value="inicial_solo">Solo para consulta inicial</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Preview de Recomendaciones -->
            <div class="recommendation-preview" id="recommendationPreview">
                <div class="recommendation-title">üéØ Vista Previa de Recomendaciones</div>
                <div id="previewContent">
                    <p style="color: #666; font-style: italic;">Complete la evaluaci√≥n para ver recomendaciones personalizadas...</p>
                </div>
            </div>

            <!-- Navigation -->
            <div class="navigation">
                <button class="btn btn-secondary" onclick="previousPage()">‚Üê Vitiligo Actual</button>
                <div>
                    <button class="btn btn-success" onclick="saveProgress()" style="margin-right: 15px;">üíæ Guardar Progreso</button>
                    <button class="btn btn-primary" onclick="generateFinalReport()">Generar Reporte Final ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let inversionData = {};
        let calculationResults = {};

        // Funci√≥n mejorada para validaci√≥n completa
        function validateForm() {
            const errors = [];
            let isValid = true;

            // Limpiar errores previos
            clearValidationErrors();

            // Definir campos requeridos con sus mensajes personalizados
            const requiredFields = [
                {
                    id: 'pais_residencia',
                    message: 'Por favor seleccione su pa√≠s de residencia'
                },
                {
                    id: 'moneda_local',
                    message: 'Por favor indique la moneda de sus ingresos'
                },
                {
                    id: 'monto_disponible_inmediato',
                    message: 'Por favor indique cu√°nto puede destinar inmediatamente'
                },
                {
                    id: 'monto_mensual_sostenible',
                    message: 'Por favor indique cu√°nto puede destinar mensualmente'
                }
            ];

            // Validar campos select requeridos
            requiredFields.forEach(fieldData => {
                const field = document.getElementById(fieldData.id);
                if (!field || !field.value || field.value === '') {
                    showFieldError(field, fieldData.message);
                    errors.push(fieldData.message);
                    isValid = false;
                } else {
                    showFieldSuccess(field);
                }
            });

            // Validar radio buttons requeridos
            const requiredRadios = [
                {
                    name: 'estabilidad_ingresos',
                    message: 'Por favor indique qu√© tan estables son sus ingresos'
                },
                {
                    name: 'tiene_seguro',
                    message: 'Por favor indique si tiene seguro de salud'
                },
                {
                    name: 'dispuesto_viajar',
                    message: 'Por favor indique si est√° dispuesto/a a viajar por tratamiento'
                }
            ];

            requiredRadios.forEach(radioData => {
                const checked = document.querySelector(`input[name="${radioData.name}"]:checked`);
                if (!checked) {
                    errors.push(radioData.message);
                    highlightRadioGroupError(radioData.name);
                    isValid = false;
                } else {
                    clearRadioGroupError(radioData.name);
                }
            });

            // Validar selecciones especiales
            const prioridadElement = document.querySelector('.priority-level.selected');
            if (!prioridadElement) {
                errors.push('Por favor seleccione la prioridad del tratamiento');
                isValid = false;
            }

            const timelineElement = document.querySelector('.timeline-option.selected');
            if (!timelineElement) {
                errors.push('Por favor seleccione el plazo para ver resultados');
                isValid = false;
            }

            // Validaci√≥n de datos financieros
            const totalIngresos = calculationResults.totalIngresos || 0;
            const totalGastos = calculationResults.totalGastos || 0;
            
            if (totalIngresos === 0) {
                errors.push('Por favor ingrese al menos un tipo de ingreso');
                isValid = false;
            }

            if (totalGastos > totalIngresos * 1.2) {
                errors.push('Sus gastos exceden significativamente sus ingresos. Esto podr√≠a afectar las opciones de tratamiento disponibles.');
            }

            // Mostrar resumen de errores
            if (!isValid) {
                showErrorSummary(errors);
                scrollToFirstError();
            } else {
                hideErrorSummary();
            }

            return isValid;
        }

        // Funci√≥n para mostrar error en campo espec√≠fico
        function showFieldError(field, message) {
            if (!field) return;
            
            field.classList.add('field-error');
            field.classList.remove('field-success');
            
            // Crear o actualizar mensaje de error
            let errorDiv = field.parentNode.querySelector('.error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                field.parentNode.appendChild(errorDiv);
            }
            
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';

            // Agregar icono de error
            addValidationIcon(field, 'error');
        }

        // Funci√≥n para mostrar √©xito en campo
        function showFieldSuccess(field) {
            if (!field) return;
            
            field.classList.add('field-success');
            field.classList.remove('field-error');
            
            // Ocultar mensaje de error
            const errorDiv = field.parentNode.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }

            // Agregar icono de √©xito
            addValidationIcon(field, 'success');
        }

        // Funci√≥n para agregar iconos de validaci√≥n
        function addValidationIcon(field, type) {
            // Remover icono existente
            const existingIcon = field.parentNode.querySelector('.validation-icon');
            if (existingIcon) {
                existingIcon.remove();
            }

            // Agregar nuevo icono
            const icon = document.createElement('span');
            icon.className = `validation-icon ${type}`;
            icon.textContent = type === 'success' ? '‚úì' : '‚úó';
            field.parentNode.appendChild(icon);
        }

        // Funci√≥n para limpiar errores de validaci√≥n
        function clearValidationErrors() {
            document.querySelectorAll('.field-error').forEach(field => {
                field.classList.remove('field-error');
            });
            
            document.querySelectorAll('.error-message').forEach(msg => {
                msg.style.display = 'none';
            });
            
            document.querySelectorAll('.validation-icon').forEach(icon => {
                icon.remove();
            });

            hideErrorSummary();
        }

        // Funci√≥n para resaltar error en grupo de radio buttons
        function highlightRadioGroupError(radioName) {
            const radioContainer = document.querySelector(`input[name="${radioName}"]`).closest('.subsection');
            if (radioContainer) {
                radioContainer.style.borderLeft = '5px solid #e74c3c';
                radioContainer.style.backgroundColor = '#fdf2f2';
            }
        }

        // Funci√≥n para limpiar error en grupo de radio buttons
        function clearRadioGroupError(radioName) {
            const radioContainer = document.querySelector(`input[name="${radioName}"]`).closest('.subsection');
            if (radioContainer) {
                radioContainer.style.borderLeft = '5px solid #3498db';
                radioContainer.style.backgroundColor = '#f8f9fa';
            }
        }

        // Funci√≥n para mostrar resumen de errores
        function showErrorSummary(errors) {
            let errorSummary = document.getElementById('errorSummary');
            
            if (!errorSummary) {
                errorSummary = document.createElement('div');
                errorSummary.id = 'errorSummary';
                errorSummary.className = 'error-summary';
                
                const container = document.querySelector('.inversion-container');
                container.insertBefore(errorSummary, container.firstChild);
            }

            errorSummary.innerHTML = `
                <h4>‚ö†Ô∏è Por favor corrija los siguientes errores:</h4>
                <ul class="error-list">
                    ${errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            `;
            
            errorSummary.style.display = 'block';
        }

        // Funci√≥n para ocultar resumen de errores
        function hideErrorSummary() {
            const errorSummary = document.getElementById('errorSummary');
            if (errorSummary) {
                errorSummary.style.display = 'none';
            }
        }

        // Funci√≥n para hacer scroll al primer error
        function scrollToFirstError() {
            const firstError = document.querySelector('.field-error, .error-summary');
            if (firstError) {
                firstError.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }

        // Funci√≥n para mostrar mensaje de √©xito
        function showSuccessMessage(message) {
            let successDiv = document.getElementById('successMessage');
            
            if (!successDiv) {
                successDiv = document.createElement('div');
                successDiv.id = 'successMessage';
                successDiv.className = 'success-message';
                
                const container = document.querySelector('.inversion-container');
                container.insertBefore(successDiv, container.firstChild);
            }

            successDiv.innerHTML = `‚úÖ ${message}`;
            successDiv.style.display = 'block';

            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Funci√≥n para mostrar mensaje de advertencia
        function showWarningMessage(message) {
            let warningDiv = document.getElementById('warningMessage');
            
            if (!warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'warningMessage';
                warningDiv.className = 'alert alert-warning';
                warningDiv.style.margin = '20px 0';
                
                const container = document.querySelector('.inversion-container');
                container.insertBefore(warningDiv, container.firstChild);
            }

            warningDiv.innerHTML = `‚ö†Ô∏è ${message}`;
            warningDiv.style.display = 'block';

            // Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                warningDiv.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n mejorada para guardar progreso
        function saveProgress() {
            try {
                inversionData = collectAllData();
                localStorage.setItem('capacidadInversionData', JSON.stringify(inversionData));
                
                // Marcar paso como completado
                localStorage.setItem('capacidadInversionCompleted', 'true');
                
                // Mostrar confirmaci√≥n visual
                showSuccessMessage('Progreso guardado exitosamente. Sus datos financieros est√°n seguros y encriptados.');
                
                // Actualizar barra de progreso
                updateProgressBar();
                
                console.log('‚úÖ Capacidad de inversi√≥n guardada exitosamente');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error guardando progreso:', error);
                alert('Error al guardar el progreso. Por favor intente nuevamente.');
                return false;
            }
        }

        // Funci√≥n para actualizar barra de progreso
        function updateProgressBar() {
            const progressFill = document.querySelector('.progress-fill');
            const currentStep = document.querySelector('.step.active');
            
            if (progressFill) {
                progressFill.style.width = '100%'; // Paso completado
            }
            
            if (currentStep) {
                currentStep.classList.remove('active');
                currentStep.classList.add('completed');
            }
        }

        // Funci√≥n mejorada para cargar datos guardados
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('capacidadInversionData');
                if (savedData) {
                    inversionData = JSON.parse(savedData);
                    
                    // Restaurar campos de formulario
                    restoreFormFields(inversionData);
                    
                    // Restaurar selecciones especiales
                    restoreSpecialSelections(inversionData);
                    
                    // Recalcular despu√©s de cargar
                    setTimeout(() => {
                        calculateFinancialSummary();
                        updateRecommendationPreview();
                    }, 100);

                    console.log('‚úÖ Datos de capacidad de inversi√≥n cargados exitosamente');
                    return true;
                }
                return false;
                
            } catch (error) {
                console.error('‚ùå Error cargando datos guardados:', error);
                return false;
            }
        }

        // Funci√≥n para restaurar campos de formulario
        function restoreFormFields(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                if (element && data[key] !== undefined && data[key] !== null) {
                    if (element.type === 'checkbox') {
                        element.checked = true;
                        element.closest('.checkbox-item')?.classList.add('checked');
                    } else if (element.type === 'radio' && element.value === data[key]) {
                        element.checked = true;
                        element.closest('.radio-item')?.classList.add('selected');
                    } else if (element.type !== 'radio') {
                        element.value = data[key];
                    }
                    
                    // Disparar eventos para actualizar validaciones
                    element.dispatchEvent(new Event('input', { bubbles: true }));
                    element.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });

            // Restaurar recursos seleccionados
            if (data.recursos && Array.isArray(data.recursos)) {
                data.recursos.forEach(recursoId => {
                    const recurso = document.getElementById(recursoId);
                    if (recurso) {
                        recurso.checked = true;
                        recurso.closest('.checkbox-item')?.classList.add('checked');
                    }
                });
            }
        }

        // Funci√≥n para restaurar selecciones especiales
        function restoreSpecialSelections(data) {
            // Restaurar prioridad
            if (data.prioridad_tratamiento) {
                const priorityElement = document.querySelector(`[data-value="${data.prioridad_tratamiento}"]`);
                if (priorityElement && priorityElement.classList.contains('priority-level')) {
                    document.querySelectorAll('.priority-level').forEach(el => el.classList.remove('selected'));
                    priorityElement.classList.add('selected');
                    document.getElementById('prioridad_tratamiento').value = data.prioridad_tratamiento;
                }
            }

            // Restaurar timeline
            if (data.timeline_resultados) {
                const timelineElement = document.querySelector(`[data-value="${data.timeline_resultados}"]`);
                if (timelineElement && timelineElement.classList.contains('timeline-option')) {
                    document.querySelectorAll('.timeline-option').forEach(el => el.classList.remove('selected'));
                    timelineElement.classList.add('selected');
                    document.getElementById('timeline_resultados').value = data.timeline_resultados;
                }
            }
        }

        // Funci√≥n mejorada para ir a p√°gina anterior
        function previousPage() {
            // Guardar progreso antes de salir
            const saved = saveProgress();
            
            if (saved) {
                setTimeout(() => {
                    window.location.href = 'vitiligo_actual.html';
                }, 500); // Peque√±o delay para que se vea el mensaje de √©xito
            }
        }

        // Funci√≥n para generar reporte final
        function generateFinalReport() {
            // Validar formulario
            if (!validateForm()) {
                return;
            }

            // Mostrar indicador de carga
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Generando reporte...';
            button.disabled = true;

            try {
                // Guardar datos finales
                saveProgress();
                
                // Combinar todos los datos de pasos anteriores
                const allData = {
                    capacidadInversion: collectAllData(),
                    datosBasicos: JSON.parse(localStorage.getItem('datosBasicos') || '{}'),
                    fitzpatrick: JSON.parse(localStorage.getItem('fitzpatrickData') || '{}'),
                    antecedentes: JSON.parse(localStorage.getItem('antecedentesData') || '{}'),
                    vitiligoActual: JSON.parse(localStorage.getItem('vitiligoActualData') || '{}')
                };

                // Guardar datos completos
                localStorage.setItem('reporteCompleto', JSON.stringify(allData));
                
                // Mostrar √©xito
                showSuccessMessage('Datos guardados exitosamente. Generando su reporte personalizado...');
                
                // Redireccionar al reporte final despu√©s de un breve delay
                setTimeout(() => {
                    window.location.href = 'reporte_final.html';
                }, 1500);

            } catch (error) {
                console.error('Error al guardar datos:', error);
                alert('‚ùå Error al procesar sus datos. Por favor intente nuevamente.');
                
                // Restaurar bot√≥n
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Calcular resumen financiero
        function calculateFinancialSummary() {
            const incomeInputs = [
                'ingreso_trabajo', 'ingreso_secundario', 'ingreso_inversiones', 
                'ingreso_pension', 'ingreso_otros', 'ingreso_conyuge'
            ];
            
            const expenseInputs = [
                'gasto_vivienda', 'gasto_alimentacion', 'gasto_transporte', 
                'gasto_servicios', 'gasto_seguros', 'gasto_deudas', 
                'gasto_educacion', 'gasto_salud_actual', 'gasto_otros'
            ];

            let totalIngresos = 0;
            let totalGastos = 0;

            incomeInputs.forEach(id => {
                const value = parseFloat(document.getElementById(id).value) || 0;
                totalIngresos += value;
            });

            expenseInputs.forEach(id => {
                const value = parseFloat(document.getElementById(id).value) || 0;
                totalGastos += value;
            });

            const disponible = totalIngresos - totalGastos;

            // Actualizar display
            document.getElementById('total_ingresos').textContent = totalIngresos.toLocaleString();
            document.getElementById('total_gastos').textContent = totalGastos.toLocaleString();
            document.getElementById('total_disponible').textContent = disponible.toLocaleString();

            // Colorear seg√∫n disponibilidad
            const disponibleElement = document.getElementById('disponible_color');
            if (disponible > 0) {
                disponibleElement.style.color = '#27ae60';
            } else if (disponible < 0) {
                disponibleElement.style.color = '#e74c3c';
            } else {
                disponibleElement.style.color = '#f39c12';
            }

            // Guardar resultados
            calculationResults = {
                totalIngresos,
                totalGastos,
                disponible,
                porcentajeDisponible: totalIngresos > 0 ? (disponible / totalIngresos) * 100 : 0
            };
        }

        // Inicializar calculadoras
        function initializeCalculators() {
            calculateFinancialSummary();
        }

        // Funci√≥n para selecci√≥n de prioridad
        function initializePrioritySelection() {
            const priorityLevels = document.querySelectorAll('.priority-level');
            
            priorityLevels.forEach(level => {
                level.addEventListener('click', function() {
                    // Remover selecci√≥n previa
                    priorityLevels.forEach(l => l.classList.remove('selected'));
                    // Seleccionar actual
                    this.classList.add('selected');
                    // Guardar valor
                    document.getElementById('prioridad_tratamiento').value = this.dataset.value;
                    updateRecommendationPreview();
                });
            });
        }

        // Funci√≥n para selecci√≥n de timeline
        function initializeTimelineSelection() {
            const timelineOptions = document.querySelectorAll('.timeline-option');
            
            timelineOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remover selecci√≥n previa
                    timelineOptions.forEach(o => o.classList.remove('selected'));
                    // Seleccionar actual
                    this.classList.add('selected');
                    // Guardar valor
                    document.getElementById('timeline_resultados').value = this.dataset.value;
                    updateRecommendationPreview();
                });
            });
        }

        // Funci√≥n para mostrar/ocultar detalles de seguro
        function initializeInsuranceToggles() {
            const seguroOptions = document.querySelectorAll('input[name="tiene_seguro"]');
            const seguroDetalles = document.getElementById('seguro_detalles');

            seguroOptions.forEach(option => {
                option.addEventListener('change', function() {
                    if (this.value !== 'no') {
                        seguroDetalles.style.display = 'block';
                    } else {
                        seguroDetalles.style.display = 'none';
                    }
                });
            });
        }

        // Funci√≥n para mostrar/ocultar detalles de viaje
        function initializeTravelToggles() {
            const viajeOptions = document.querySelectorAll('input[name="dispuesto_viajar"]');
            const viajeDetalles = document.getElementById('viaje_detalles');

            viajeOptions.forEach(option => {
                option.addEventListener('change', function() {
                    if (this.value !== 'no') {
                        viajeDetalles.style.display = 'block';
                    } else {
                        viajeDetalles.style.display = 'none';
                    }
                });
            });
        }

        // Funci√≥n para manejar recursos mutuamente excluyentes
        function initializeResourceToggles() {
            const recursoNinguno = document.getElementById('recurso_ninguno');
            const otrosRecursos = document.querySelectorAll('.checkbox-item input[type="checkbox"]:not(#recurso_ninguno)');

            recursoNinguno.addEventListener('change', function() {
                if (this.checked) {
                    otrosRecursos.forEach(recurso => {
                        if (recurso.closest('.checkbox-item')) {
                            recurso.checked = false;
                            recurso.closest('.checkbox-item').classList.remove('checked');
                        }
                    });
                }
            });

            otrosRecursos.forEach(recurso => {
                recurso.addEventListener('change', function() {
                    if (this.checked && recursoNinguno.checked) {
                        recursoNinguno.checked = false;
                        recursoNinguno.closest('.checkbox-item').classList.remove('checked');
                    }
                });
            });

            // Agregar funcionalidad visual a checkboxes
            document.querySelectorAll('.checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            item.classList.add('checked');
                        } else {
                            item.classList.remove('checked');
                        }
                    });
                }
            });

            // Agregar funcionalidad visual a radio buttons
            document.querySelectorAll('.radio-item').forEach(item => {
                const radio = item.querySelector('input[type="radio"]');
                if (radio) {
                    radio.addEventListener('change', function() {
                        // Remover selecci√≥n de otros en el mismo grupo
                        const name = this.name;
                        document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                            r.closest('.radio-item').classList.remove('selected');
                        });
                        // Agregar selecci√≥n al actual
                        item.classList.add('selected');
                    });
                }
            });
        }

        // Validaci√≥n mejorada en tiempo real
        function setupRealTimeValidation() {
            // Configurar validaci√≥n para campos requeridos
            const requiredSelects = ['pais_residencia', 'moneda_local', 'monto_disponible_inmediato', 'monto_mensual_sostenible'];
            
            requiredSelects.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', function() {
                        if (this.value && this.value !== '') {
                            showFieldSuccess(this);
                        } else {
                            showFieldError(this, `Este campo es requerido`);
                        }
                        updateRecommendationPreview();
                    });
                    
                    field.addEventListener('blur', function() {
                        if (!this.value || this.value === '') {
                            showFieldError(this, `Por favor seleccione una opci√≥n`);
                        }
                    });
                }
            });

            // Configurar validaci√≥n para radio buttons
            const radioGroups = ['estabilidad_ingresos', 'tiene_seguro', 'dispuesto_viajar'];
            
            radioGroups.forEach(groupName => {
                const radios = document.querySelectorAll(`input[name="${groupName}"]`);
                radios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        clearRadioGroupError(groupName);
                        updateRecommendationPreview();
                    });
                });
            });

            // Configurar validaci√≥n para campos num√©ricos
            const numericInputs = document.querySelectorAll('input[type="number"]');
            numericInputs.forEach(input => {
                input.addEventListener('input', function() {
                    // Validar que sea un n√∫mero v√°lido
                    const value = parseFloat(this.value);
                    if (this.value !== '' && (isNaN(value) || value < 0)) {
                        showFieldError(this, 'Por favor ingrese un n√∫mero v√°lido mayor o igual a 0');
                    } else if (this.value !== '') {
                        showFieldSuccess(this);
                    }
                });

                input.addEventListener('blur', function() {
                    // Formatear el n√∫mero al perder el foco
                    if (this.value && !isNaN(this.value)) {
                        this.value = parseFloat(this.value).toFixed(0);
                    }
                });
            });

            // Configurar validaci√≥n para checkboxes de recursos
            const resourceCheckboxes = document.querySelectorAll('.checkbox-item input[type="checkbox"]');
            resourceCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // Verificar que al menos uno est√© seleccionado
                    const anySelected = Array.from(resourceCheckboxes).some(cb => cb.checked);
                    if (!anySelected) {
                        // Mostrar advertencia si no hay recursos seleccionados
                        setTimeout(() => {
                            if (!Array.from(resourceCheckboxes).some(cb => cb.checked)) {
                                showWarningMessage('Se recomienda seleccionar al menos un recurso disponible para obtener mejores recomendaciones.');
                            }
                        }, 100);
                    }
                    updateRecommendationPreview();
                });
            });
        }

        // Configurar actualizaciones en tiempo real mejoradas
        function setupRealTimeUpdates() {
            // Calculadora de ingresos y gastos
            const incomeInputs = document.querySelectorAll('#ingreso_trabajo, #ingreso_secundario, #ingreso_inversiones, #ingreso_pension, #ingreso_otros, #ingreso_conyuge');
            const expenseInputs = document.querySelectorAll('#gasto_vivienda, #gasto_alimentacion, #gasto_transporte, #gasto_servicios, #gasto_seguros, #gasto_deudas, #gasto_educacion, #gasto_salud_actual, #gasto_otros');

            [...incomeInputs, ...expenseInputs].forEach(input => {
                input.addEventListener('input', function() {
                    calculateFinancialSummary();
                    
                    // Validaci√≥n contextual
                    const value = parseFloat(this.value) || 0;
                    const isIncome = incomeInputs.includes(this);
                    
                    if (isIncome && value > 50000) {
                        showWarningMessage('Ingreso alto detectado. Esto podr√≠a abrir opciones de tratamiento premium.');
                    }
                    
                    // Actualizar recomendaciones despu√©s de cambios financieros
                    setTimeout(updateRecommendationPreview, 300);
                });
            });

            // Configurar validaci√≥n en tiempo real
            setupRealTimeValidation();
        }

        // Funci√≥n para actualizar preview de recomendaciones
        function updateRecommendationPreview() {
            const data = collectAllData();
            const investmentLevel = calculateInvestmentLevel(data);
            const preview = generatePreviewRecommendations(investmentLevel, data);
            
            document.getElementById('previewContent').innerHTML = preview;
        }

        // Calcular nivel de inversi√≥n
        function calculateInvestmentLevel(data) {
            let score = 0;

            // Factor: ingresos disponibles
            const disponible = calculationResults.disponible || 0;
            if (disponible > 3000) score += 3;
            else if (disponible > 1000) score += 2;
            else if (disponible > 500) score += 1;

            // Factor: monto mensual sostenible
            const mensual = data.monto_mensual_sostenible;
            if (mensual === 'mas_3000' || mensual === '2000_3000') score += 3;
            else if (mensual === '1000_2000' || mensual === '500_1000') score += 2;
            else if (mensual === '200_500') score += 1;

            // Factor: monto disponible inmediato
            const inmediato = data.monto_disponible_inmediato;
            if (inmediato === 'mas_10000' || inmediato === '5000_10000') score += 3;
            else if (inmediato === '2500_5000' || inmediato === '1000_2500') score += 2;
            else if (inmediato === '500_1000') score += 1;

            // Factor: recursos disponibles
            const recursos = data.recursos || [];
            if (recursos.includes('recurso_ahorros')) score += 1;
            if (recursos.includes('recurso_seguro_salud')) score += 1;
            if (recursos.includes('recurso_apoyo_familiar')) score += 1;
            if (recursos.includes('recurso_credito')) score += 1;

            // Factor: prioridad
            const prioridad = data.prioridad_tratamiento;
            if (prioridad === 'urgente') score += 2;
            else if (prioridad === 'alta') score += 1;

            // Factor: estabilidad de ingresos
            const estabilidad = data.estabilidad_ingresos;
            if (estabilidad === 'muy_estable' || estabilidad === 'estable') score += 1;

            // Determinar nivel
            if (score >= 10) return 3; // Inversi√≥n completa
            else if (score >= 6) return 2; // Inversi√≥n moderada
            else return 1; // Inversi√≥n limitada
        }

        // Generar preview de recomendaciones
        function generatePreviewRecommendations(level, data) {
            let html = '';

            if (level === 1) {
                html = `
                    <div class="recommendation-card" style="border-left-color: #e74c3c;">
                        <h4 style="color: #e74c3c;">üî¥ Plan Esencial - Inversi√≥n Limitada</h4>
                        <p><strong>Inversi√≥n mensual estimada:</strong> $200 - $500</p>
                        <ul>
                            <li>Consulta virtual inicial completa</li>
                            <li>Protocolo b√°sico con suplementos esenciales</li>
                            <li>Fototerapia casera con l√°mpara UVB-NB</li>
                            <li>Seguimiento mensual virtual</li>
                            <li>Plan de pagos sin intereses disponible</li>
                        </ul>
                    </div>
                `;
            } else if (level === 2) {
                html = `
                    <div class="recommendation-card" style="border-left-color: #f39c12;">
                        <h4 style="color: #f39c12;">üü° Plan Integral - Inversi√≥n Moderada</h4>
                        <p><strong>Inversi√≥n mensual estimada:</strong> $500 - $1,200</p>
                        <ul>
                            <li>Consulta presencial o virtual premium</li>
                            <li>An√°lisis gen√©tico completo incluido</li>
                            <li>Protocolo avanzado personalizado</li>
                            <li>Fototerapia profesional supervisada</li>
                            <li>Laboratorios especializados incluidos</li>
                        </ul>
                    </div>
                `;
            } else {
                html = `
                    <div class="recommendation-card" style="border-left-color: #27ae60;">
                        <h4 style="color: #27ae60;">üü¢ Plan Premium - Inversi√≥n Completa</h4>
                        <p><strong>Inversi√≥n mensual estimada:</strong> $1,200 - $3,000</p>
                        <ul>
                            <li>Protocolo completo con todos los tratamientos</li>
                            <li>Consultas presenciales en Miami</li>
                            <li>Tratamientos biol√≥gicos cuando sean necesarios</li>
                            <li>Seguimiento VIP con acceso 24/7</li>
                            <li>Garant√≠a de resultados premium</li>
                        </ul>
                    </div>
                `;
            }

            // Agregar informaci√≥n sobre viajes si es relevante
            if (data.dispuesto_viajar && data.dispuesto_viajar !== 'no') {
                html += `
                    <div style="margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                        <strong>üí° Recomendaci√≥n adicional:</strong> Dado que est√° dispuesto/a a viajar, 
                        podemos optimizar su plan combinando consultas presenciales estrat√©gicas con 
                        seguimiento virtual, maximizando la efectividad del tratamiento.
                    </div>
                `;
            }

            return html;
        }

        // Funci√≥n para recopilar todos los datos
        function collectAllData() {
            const data = {};
            
            // Recopilar todos los inputs
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    if (input.checked) {
                        if (!data.recursos) data.recursos = [];
                        data.recursos.push(input.id);
                    }
                } else if (input.type === 'radio') {
                    if (input.checked) {
                        data[input.name] = input.value;
                    }
                } else if (input.value) {
                    data[input.id || input.name] = input.value;
                }
            });

            // Incluir resultados de c√°lculos
            data.calculationResults = calculationResults;

            // Incluir selecciones especiales
            const selectedPriority = document.querySelector('.priority-level.selected');
            if (selectedPriority) {
                data.prioridad_tratamiento = selectedPriority.dataset.value;
            }

            const selectedTimeline = document.querySelector('.timeline-option.selected');
            if (selectedTimeline) {
                data.timeline_resultados = selectedTimeline.dataset.value;
            }

            return data;
        }

        // Configuraci√≥n de atajos de teclado
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl + S para guardar
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveProgress();
                }
                
                // Escape para limpiar errores
                if (e.key === 'Escape') {
                    clearValidationErrors();
                }
            });
        }

        // Configurar auto-guardado
        function setupAutoSave() {
            let autoSaveTimer;
            
            function triggerAutoSave() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    saveProgress();
                }, 30000); // Auto-guardar cada 30 segundos
            }

            // Configurar auto-guardado en cambios
            document.addEventListener('input', triggerAutoSave);
            document.addEventListener('change', triggerAutoSave);
        }

        // Prevenir p√©rdida de datos
        function setupBeforeUnload() {
            window.addEventListener('beforeunload', function(e) {
                const hasUnsavedChanges = checkForUnsavedChanges();
                if (hasUnsavedChanges) {
                    const message = 'Tiene cambios sin guardar. ¬øEst√° seguro que desea salir?';
                    e.returnValue = message;
                    return message;
                }
            });
        }

        // Verificar cambios sin guardar
        function checkForUnsavedChanges() {
            const currentData = collectAllData();
            const savedData = JSON.parse(localStorage.getItem('capacidadInversionData') || '{}');
            
            return JSON.stringify(currentData) !== JSON.stringify(savedData);
        }

        // Configuraci√≥n mejorada de inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando Capacidad de Inversi√≥n...');
            
            try {
                // Inicializar componentes principales
                initializeCalculators();
                initializePrioritySelection();
                initializeTimelineSelection();
                initializeInsuranceToggles();
                initializeTravelToggles();
                initializeResourceToggles();
                
                // Configurar actualizaciones y validaciones
                setupRealTimeUpdates();
                setupKeyboardShortcuts();
                setupAutoSave();
                setupBeforeUnload();
                
                // Cargar datos guardados
                const dataLoaded = loadSavedData();
                
                // Mostrar mensaje de bienvenida
                if (dataLoaded) {
                    showSuccessMessage('Datos previos cargados exitosamente. Puede continuar donde lo dej√≥.');
                } else {
                    console.log('üìã Iniciando evaluaci√≥n de capacidad de inversi√≥n...');
                }
                
                console.log('‚úÖ Inicializaci√≥n completada exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error durante la inicializaci√≥n:', error);
                alert('Error al cargar la p√°gina. Por favor recargue el navegador.');
            }
        });
    </script>
</body>
</html>
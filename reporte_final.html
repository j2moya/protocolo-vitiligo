<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Final - Protocolo Vitiligo Dr. Jos√© Moya</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 300;
        }

        .header h2 {
            color: #3498db;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
            max-width: 800px;
            margin: 0 auto;
        }

        .progress-bar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress {
            width: 100%;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 100%;
            transition: width 0.3s ease;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px 5px;
            border-radius: 5px;
            margin: 0 2px;
            background: #27ae60;
            color: white;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .step.active {
            background: #3498db;
            color: white;
        }

        .reporte-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .report-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 3px solid #3498db;
        }

        .report-title {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .report-subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .report-date {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 600;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .section-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .patient-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ecf0f1;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .card-content {
            color: #666;
            line-height: 1.5;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .risk-assessment {
            background: linear-gradient(135deg, #e8f6fd, #ffffff);
            border: 2px solid #3498db;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .risk-level {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .low-risk { color: #27ae60; }
        .medium-risk { color: #f39c12; }
        .high-risk { color: #e74c3c; }

        .risk-description {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 20px;
        }

        .treatment-plan {
            background: linear-gradient(135deg, #d5f4e6, #ffffff);
            border: 2px solid #27ae60;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .plan-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #27ae60;
            margin-bottom: 20px;
            text-align: center;
        }

        .plan-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .plan-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .plan-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .plan-section ul {
            list-style: none;
            padding: 0;
        }

        .plan-section li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
            position: relative;
            padding-left: 25px;
        }

        .plan-section li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #27ae60;
            font-weight: bold;
        }

        .investment-breakdown {
            background: #2c3e50;
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .investment-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            text-align: center;
        }

        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .cost-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .cost-amount {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .cost-description {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .fitzpatrick-display {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .fitzpatrick-type {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .fitzpatrick-description {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .fitzpatrick-protocol {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .timeline {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .timeline-title {
            font-size: 1.4em;
            margin-bottom: 25px;
            text-align: center;
        }

        .timeline-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .timeline-step {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .step-number {
            background: rgba(255,255,255,0.3);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: bold;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .step-description {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .recommendations {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .recommendations-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            text-align: center;
        }

        .recommendation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .recommendation-item {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 10px;
        }

        .recommendation-item h4 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .contact-section {
            background: #2c3e50;
            color: white;
            border-radius: 15px;
            padding: 40px;
            margin: 40px 0;
            text-align: center;
        }

        .contact-title {
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        .contact-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }

        .contact-method {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
        }

        .contact-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .contact-details {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39,174,96,0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23,162,184,0.3);
        }

        .alert {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        .footer {
            background: #2c3e50;
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-top: 40px;
        }

        .footer-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .disclaimer {
            font-size: 0.9em;
            opacity: 0.8;
            line-height: 1.6;
            margin: 20px 0;
        }

        .actions {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .print-hidden {
            display: block;
        }

        @media print {
            body {
                background: white;
                color: black;
            }
            
            .print-hidden {
                display: none !important;
            }
            
            .container {
                max-width: 100%;
                padding: 0;
            }
            
            .section {
                break-inside: avoid;
                margin-bottom: 20px;
            }
            
            .btn {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .reporte-container {
                padding: 20px;
            }
            
            .patient-summary {
                grid-template-columns: 1fr;
            }
            
            .plan-details {
                grid-template-columns: 1fr;
            }
            
            .cost-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .timeline-steps {
                grid-template-columns: 1fr;
            }
            
            .contact-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
        <!-- Agregar despu√©s del <head> en cada p√°gina del protocolo -->
            <script>
                // Script de protecci√≥n - Agregar a TODAS las p√°ginas del protocolo
                document.addEventListener('DOMContentLoaded', async function() {
                    // Verificar sesi√≥n antes de cargar contenido
                    const sesionValida = await verificarSesionActiva();
                    
                    if (!sesionValida) {
                        // Guardar la p√°gina que intentaba acceder
                        localStorage.setItem('paginaDestino', window.location.pathname);
                        
                        // Mostrar mensaje y redirigir
                        alert('üîí Acceso restringido\n\nDebe iniciar sesi√≥n para acceder a la evaluaci√≥n m√©dica.');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Si la sesi√≥n es v√°lida, continuar cargando la p√°gina
                    inicializarPaginaProtegida();
                });
                
                async function verificarSesionActiva() {
                    try {
                        const response = await fetch('/pidasalud/protocolo-vitiligo/api.php/auth/status', {
                            method: 'GET',
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            return result.authenticated === true;
                        }
                        return false;
                    } catch (error) {
                        console.error('Error verificando sesi√≥n:', error);
                        return false;
                    }
                }
                
                function inicializarPaginaProtegida() {
                    // Aqu√≠ va el c√≥digo de inicializaci√≥n de cada p√°gina
                    console.log('P√°gina protegida cargada correctamente');
                    
                    // Agregar header de navegaci√≥n con logout
                    agregarHeaderProtegido();
                    
                    // Guardar progreso autom√°ticamente
                    guardarProgresoAutomatico();
                }
                
                function agregarHeaderProtegido() {
                    // Crear header con info de usuario y logout
                    const headerHTML = `
                        <div style="
                            background: linear-gradient(135deg, #2c3e50, #3498db);
                            color: white;
                            padding: 15px;
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            z-index: 1000;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        ">
                            <div>
                                <strong>üè• Protocolo Vitiligo - Dr. Jos√© Moya</strong>
                                <span style="margin-left: 20px;">üë§ <span id="nombreUsuarioHeader">Evaluaci√≥n en progreso</span></span>
                            </div>
                            <div>
                                <button onclick="guardarProgreso()" style="
                                    background: rgba(255,255,255,0.2);
                                    border: 1px solid rgba(255,255,255,0.3);
                                    color: white;
                                    padding: 8px 15px;
                                    border-radius: 5px;
                                    margin-right: 10px;
                                    cursor: pointer;
                                ">üíæ Guardar</button>
                                <button onclick="irALogout()" style="
                                    background: #e74c3c;
                                    border: none;
                                    color: white;
                                    padding: 8px 15px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                ">üö™ Cerrar Sesi√≥n</button>
                            </div>
                        </div>
                    `;
                    
                    // Insertar al inicio del body
                    document.body.insertAdjacentHTML('afterbegin', headerHTML);
                    
                    // Ajustar el margen del contenido principal
                    document.body.style.paddingTop = '70px';
                    
                    // Mostrar nombre de usuario si est√° disponible
                    const nombreUsuario = localStorage.getItem('usuario_nombre');
                    if (nombreUsuario) {
                        document.getElementById('nombreUsuarioHeader').textContent = nombreUsuario;
                    }
                }
                
                function guardarProgreso() {
                    const paginaActual = window.location.pathname.split('/').pop();
                    localStorage.setItem('evaluacionEnProgreso', paginaActual);
                    localStorage.setItem('ultimoGuardado', new Date().toISOString());
                    
                    // Mostrar confirmaci√≥n visual
                    mostrarMensajeGuardado();
                }
                
                function guardarProgresoAutomatico() {
                    // Guardar progreso cada 30 segundos
                    setInterval(guardarProgreso, 30000);
                    
                    // Guardar al cambiar de p√°gina
                    window.addEventListener('beforeunload', guardarProgreso);
                }
                
                function mostrarMensajeGuardado() {
                    const mensaje = document.createElement('div');
                    mensaje.innerHTML = 'üíæ Progreso guardado';
                    mensaje.style.cssText = `
                        position: fixed;
                        top: 80px;
                        right: 20px;
                        background: #27ae60;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 5px;
                        z-index: 1001;
                        animation: fadeInOut 3s ease;
                    `;
                    
                    document.body.appendChild(mensaje);
                    setTimeout(() => mensaje.remove(), 3000);
                }
                
                function irALogout() {
                    const confirmar = confirm('¬øEst√° seguro que desea cerrar sesi√≥n?\n\nSu progreso ser√° guardado autom√°ticamente.');
                    if (confirmar) {
                        guardarProgreso();
                        window.location.href = 'logout.html';
                    }
                }
                
                // CSS para la animaci√≥n
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translateX(100%); }
                        20% { opacity: 1; transform: translateX(0); }
                        80% { opacity: 1; transform: translateX(0); }
                        100% { opacity: 0; transform: translateX(100%); }
                    }
                `;
                document.head.appendChild(style);
                </script>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Reporte Integral Personalizado</h1>
            <h2>Protocolo de Vitiligo - Dr. Jos√© Moya</h2>
            <p>Evaluaci√≥n completa con recomendaciones espec√≠ficas para su caso √∫nico</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar print-hidden">
            <div class="progress">
                <div class="progress-fill"></div>
            </div>
            <div class="step-indicator">
                <div class="step">Datos B√°sicos</div>
                <div class="step">Fitzpatrick</div>
                <div class="step">Antecedentes</div>
                <div class="step">Vitiligo Actual</div>
                <div class="step">Capacidad Inversi√≥n</div>
                <div class="step active">Reporte</div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <div class="loading-spinner"></div>
            <h3>Generando su reporte personalizado...</h3>
            <p>Por favor espere mientras procesamos su informaci√≥n</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state" style="display: none;">
            <h3>‚ùå Error al cargar el reporte</h3>
            <p id="errorMessage">Ha ocurrido un error inesperado.</p>
            <button class="btn btn-primary" onclick="location.reload()">üîÑ Reintentar</button>
        </div>

        <!-- Main Report Container -->
        <div class="reporte-container" id="reportContainer" style="display: none;">
            <div class="report-header">
                <div class="report-title">Reporte M√©dico Personalizado</div>
                <div class="report-subtitle">Protocolo Integral de Vitiligo</div>
                <div class="report-date" id="reportDate">Generado el: --</div>
            </div>

            <!-- Patient Summary Section -->
            <div class="section">
                <h3 class="section-title">
                    <span class="section-icon">üë§</span>
                    Resumen del Paciente
                </h3>
                
                <div class="patient-summary" id="patientSummary">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Fitzpatrick Assessment -->
            <div class="fitzpatrick-display" id="fitzpatrickDisplay">
                <!-- Content will be populated by JavaScript -->
            </div>

            <!-- Risk Assessment Section -->
            <div class="section">
                <h3 class="section-title">
                    <span class="section-icon">‚ö†Ô∏è</span>
                    Evaluaci√≥n de Riesgo
                </h3>
                
                <div class="risk-assessment" id="riskAssessment">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Current Condition Summary -->
            <div class="section">
                <h3 class="section-title">
                    <span class="section-icon">üîç</span>
                    Estado Actual del Vitiligo
                </h3>
                
                <div id="currentCondition">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Personalized Treatment Plan -->
            <div class="treatment-plan" id="treatmentPlan">
                <!-- Content will be populated by JavaScript -->
            </div>

            <!-- Investment Breakdown -->
            <div class="investment-breakdown" id="investmentBreakdown">
                <!-- Content will be populated by JavaScript -->
            </div>

            <!-- Treatment Timeline -->
            <div class="timeline" id="treatmentTimeline">
                <!-- Content will be populated by JavaScript -->
            </div>

            <!-- Specific Recommendations -->
            <div class="recommendations" id="specificRecommendations">
                <!-- Content will be populated by JavaScript -->
            </div>

            <!-- Contact Section -->
            <div class="contact-section">
                <div class="contact-title">¬øListo para Comenzar su Tratamiento?</div>
                <p style="margin-bottom: 30px;">El Dr. Jos√© Moya y su equipo est√°n listos para acompa√±arlo en su proceso de recuperaci√≥n</p>
                
                <div class="contact-info">
                    <div class="contact-method">
                        <div class="contact-icon">üìß</div>
                        <div class="contact-details">Email</div>
                        <div>info@drmoya.com</div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">Respuesta en 24 horas</div>
                    </div>
                    <div class="contact-method">
                        <div class="contact-icon">üì±</div>
                        <div class="contact-details">WhatsApp</div>
                        <div>+1 (305) 555-0123</div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">Consultas r√°pidas</div>
                    </div>
                    <div class="contact-method">
                        <div class="contact-icon">üè•</div>
                        <div class="contact-details">Consulta Presencial</div>
                        <div>Miami, Florida</div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">Cita previa requerida</div>
                    </div>
                    <div class="contact-method">
                        <div class="contact-icon">üíª</div>
                        <div class="contact-details">Consulta Virtual</div>
                        <div>Zoom/Telemedicina</div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">Disponible mundialmente</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="actions print-hidden">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">Acciones Disponibles</h3>
                <button class="btn btn-success" onclick="scheduleConsultation()" id="btnSchedule">üìÖ Agendar Consulta</button>
                <button class="btn btn-primary" onclick="downloadPDF()" id="btnPDF">üìÑ Descargar PDF</button>
                <button class="btn btn-info" onclick="sendByEmail()" id="btnEmail">üìß Enviar por Email</button>
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir Reporte</button>
                <button class="btn btn-info" onclick="saveToCloud()" id="btnSave">‚òÅÔ∏è Guardar en la Nube</button>
            </div>

            <!-- Important Alerts -->
            <div id="importantAlerts">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-content">
                <h3>Dr. Jos√© Moya - Especialista en Vitiligo</h3>
                <p>40 a√±os de experiencia en medicina especializada</p>
                <div class="disclaimer">
                    <strong>Aviso M√©dico:</strong> Este reporte es una evaluaci√≥n preliminar basada en la informaci√≥n proporcionada. 
                    No sustituye una consulta m√©dica presencial. Para un diagn√≥stico definitivo y plan de tratamiento, 
                    es necesaria una evaluaci√≥n cl√≠nica completa. Todos los tratamientos deben ser supervisados por un profesional m√©dico calificado.
                </div>
                <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.7;">
                    ¬© 2025 Dr. Jos√© Moya. Protocolo de Vitiligo. Todos los derechos reservados.
                </div>
            </div>
        </div>
    </div>

    <script>
        let reportData = {};
        let allPatientData = {};
        let currentEvaluationId = null;
        let currentReportId = null;

        // API Base URL
        const API_BASE = '/pidasalud/protocolo-vitiligo/api.php';

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initializeReport();
        });

        // Inicializar reporte
        async function initializeReport() {
            try {
                showLoadingState();
                
                // Verificar si hay datos en localStorage como fallback
                const localData = getLocalStorageData();
                
                if (localData && Object.keys(localData).length > 0) {
                    // Usar datos locales si est√°n disponibles
                    allPatientData = localData;
                    await generateReportFromData();
                } else {
                    // Intentar cargar desde el servidor
                    await loadDataFromServer();
                }
                
            } catch (error) {
                console.error('Error inicializando reporte:', error);
                showErrorState('Error al cargar los datos del reporte. ' + error.message);
            }
        }

        // Mostrar estado de carga
        function showLoadingState() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'none';
        }

        // Mostrar estado de error
        function showErrorState(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('reportContainer').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }

        // Mostrar reporte
        function showReport() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'block';
        }

        // Obtener datos de localStorage como fallback
        function getLocalStorageData() {
            try {
                const combinedData = localStorage.getItem('reporteCompleto');
                if (combinedData) {
                    return JSON.parse(combinedData);
                }
                
                // Cargar datos individuales como √∫ltimo recurso
                return {
                    datosBasicos: JSON.parse(localStorage.getItem('datosBasicos') || '{}'),
                    fitzpatrick: JSON.parse(localStorage.getItem('fitzpatrickData') || '{}'),
                    antecedentes: JSON.parse(localStorage.getItem('antecedentesData') || '{}'),
                    vitiligoActual: JSON.parse(localStorage.getItem('vitiligoActualData') || '{}'),
                    capacidadInversion: JSON.parse(localStorage.getItem('capacidadInversionData') || '{}')
                };
            } catch (error) {
                console.error('Error cargando datos locales:', error);
                return {};
            }
        }

        // Cargar datos desde el servidor
        async function loadDataFromServer() {
            try {
                const response = await fetch(`${API_BASE}/evaluacion/cargar`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('No se pudieron cargar los datos del servidor');
                }

                const result = await response.json();
                
                if (result.success) {
                    allPatientData = result.evaluacion;
                    currentEvaluationId = result.evaluacion.evaluacion.id;
                    await generateReportFromData();
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
                
            } catch (error) {
                // Si falla el servidor, intentar con datos locales
                const localData = getLocalStorageData();
                if (localData && Object.keys(localData).length > 0) {
                    allPatientData = localData;
                    await generateReportFromData();
                    showAlert('Datos cargados desde cache local. Algunos datos podr√≠an no estar actualizados.', 'warning');
                } else {
                    throw error;
                }
            }
        }

        // Generar reporte desde los datos
        async function generateReportFromData() {
            try {
                // Generar reporte en el servidor si es posible
                await generateServerReport();
                
                // Generar contenido del reporte
                setReportDate();
                generatePatientSummary();
                generateFitzpatrickDisplay();
                generateRiskAssessment();
                generateCurrentCondition();
                generateTreatmentPlan();
                generateInvestmentBreakdown();
                generateTimeline();
                generateRecommendations();
                generateAlerts();
                
                showReport();
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                // Continuar con generaci√≥n local
                setReportDate();
                generatePatientSummary();
                generateFitzpatrickDisplay();
                generateRiskAssessment();
                generateCurrentCondition();
                generateTreatmentPlan();
                generateInvestmentBreakdown();
                generateTimeline();
                generateRecommendations();
                generateAlerts();
                showReport();
            }
        }

        // Generar reporte en el servidor
        async function generateServerReport() {
            try {
                const response = await fetch(`${API_BASE}/reporte/generar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        evaluacion_id: currentEvaluationId
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentReportId = result.reporte_id;
                        if (result.datos) {
                            allPatientData = result.datos;
                        }
                    }
                }
            } catch (error) {
                console.log('Reporte del servidor no disponible, usando datos locales');
            }
        }

        // Establecer fecha del reporte
        function setReportDate() {
            const now = new Date();
            const dateString = now.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('reportDate').textContent = `Generado el: ${dateString}`;
        }

        // Generar resumen del paciente
        function generatePatientSummary() {
            const datos = allPatientData.datosBasicos || allPatientData.datos_basicos || {};
            const capacidad = allPatientData.capacidadInversion || allPatientData.capacidad_inversion || {};
            const vitiligo = allPatientData.vitiligoActual || allPatientData.vitiligo_actual || {};
            
            const summaryHtml = `
                <div class="summary-card">
                    <div class="card-title">Informaci√≥n Personal</div>
                    <div class="card-content">
                        <strong>Nombre:</strong> ${datos.nombre || 'No especificado'}<br>
                        <strong>Edad:</strong> ${datos.edad || 'No especificado'} a√±os<br>
                        <strong>Sexo:</strong> ${datos.sexo || 'No especificado'}<br>
                        <strong>Pa√≠s:</strong> ${capacidad.pais_residencia || datos.pais || 'No especificado'}<br>
                        <strong>Email:</strong> ${datos.email || 'No especificado'}
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-title">Tiempo con Vitiligo</div>
                    <div class="card-content">
                        <strong>Inicio:</strong> ${getTimeDescription(vitiligo.tiempo_inicio)}<br>
                        <strong>Progresi√≥n:</strong> ${getProgressionDescription(vitiligo.progresion_selected || vitiligo.progresion)}<br>
                        <strong>VASI Total:</strong> ${vitiligo.vasi_total || 'No calculado'}<br>
                        <strong>DLQI:</strong> ${getTotalDLQI(vitiligo)} / 30
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-title">Capacidad de Inversi√≥n</div>
                    <div class="card-content">
                        <strong>Nivel:</strong> ${getInvestmentLevelDescription(calculateInvestmentLevel())}<br>
                        <strong>Disponible Inmediato:</strong> ${getAmountDescription(capacidad.monto_disponible_inmediato)}<br>
                        <strong>Mensual Sostenible:</strong> ${getAmountDescription(capacidad.monto_mensual_sostenible)}<br>
                        <strong>Prioridad:</strong> ${getPriorityDescription(capacidad.prioridad_tratamiento)}
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-title">Estado del Tratamiento</div>
                    <div class="card-content">
                        <strong>Evaluaci√≥n:</strong> Completada ‚úÖ<br>
                        <strong>Reporte:</strong> Generado ‚úÖ<br>
                        <strong>Siguiente Paso:</strong> Agendar consulta<br>
                        <strong>Urgencia:</strong> ${getUrgencyLevel(capacidad.prioridad_tratamiento)}
                    </div>
                </div>
            `;
            
            document.getElementById('patientSummary').innerHTML = summaryHtml;
        }

        // Generar display de Fitzpatrick
        function generateFitzpatrickDisplay() {
            const fitzpatrick = allPatientData.fitzpatrick || allPatientData.fitzpatrick_data || {};
            const fitzType = fitzpatrick.fitzpatrick_type || fitzpatrick.fitzpatrick || 'No evaluado';
            
            const fitzData = getFitzpatrickData(fitzType);
            
            const html = `
                <div class="fitzpatrick-type">Fototipo ${fitzType}</div>
                <div class="fitzpatrick-description">${fitzData.name}</div>
                <div class="fitzpatrick-protocol">
                    <strong>Protocolo UVB-NB Recomendado:</strong><br>
                    ${fitzData.protocol}
                </div>
            `;
            
            document.getElementById('fitzpatrickDisplay').innerHTML = html;
        }

        // Generar evaluaci√≥n de riesgo
        function generateRiskAssessment() {
            const riskLevel = calculateOverallRisk();
            const riskData = getRiskData(riskLevel);
            
            const html = `
                <div class="risk-level ${riskLevel}-risk">${riskData.title}</div>
                <div class="risk-description">${riskData.description}</div>
                <div style="margin-top: 20px;">
                    <strong>Factores que contribuyen al riesgo:</strong>
                    <ul style="text-align: left; margin-top: 10px;">
                        ${generateRiskFactorDetails()}
                    </ul>
                </div>
            `;
            
            document.getElementById('riskAssessment').innerHTML = html;
        }

        // Generar condici√≥n actual
        function generateCurrentCondition() {
            const vitiligo = allPatientData.vitiligoActual || allPatientData.vitiligo_actual || {};
            
            const html = `
                <div class="patient-summary">
                    <div class="summary-card">
                        <div class="card-title">Distribuci√≥n Corporal</div>
                        <div class="card-content">
                            ${generateBodyDistribution(vitiligo)}
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="card-title">√çndices de Severidad</div>
                        <div class="card-content">
                            <strong>VASI Total:</strong> ${vitiligo.vasi_total || '0'} / 100<br>
                            <strong>Clasificaci√≥n:</strong> ${getVASIClassification(vitiligo.vasi_total)}<br>
                            <strong>DLQI Total:</strong> ${getTotalDLQI(vitiligo)} / 30<br>
                            <strong>Impacto:</strong> ${getDLQIImpact(getTotalDLQI(vitiligo))}
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="card-title">Tratamientos Previos</div>
                        <div class="card-content">
                            ${generatePreviousTreatments(vitiligo)}
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="card-title">S√≠ntomas Asociados</div>
                        <div class="card-content">
                            ${generateSymptoms(vitiligo)}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('currentCondition').innerHTML = html;
        }

        // Generar plan de tratamiento
        function generateTreatmentPlan() {
            const investmentLevel = calculateInvestmentLevel();
            const planData = getTreatmentPlanData(investmentLevel);
            
            const html = `
                <div class="plan-title">${planData.title}</div>
                <div class="plan-details">
                    <div class="plan-section">
                        <h4>üè• Consultas y Evaluaci√≥n</h4>
                        <ul>
                            ${planData.consultations.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="plan-section">
                        <h4>üíä Tratamientos Incluidos</h4>
                        <ul>
                            ${planData.treatments.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="plan-section">
                        <h4>üî¨ Estudios y An√°lisis</h4>
                        <ul>
                            ${planData.studies.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="plan-section">
                        <h4>üìÖ Seguimiento</h4>
                        <ul>
                            ${planData.followUp.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('treatmentPlan').innerHTML = html;
        }

        // Generar desglose de inversi√≥n
        function generateInvestmentBreakdown() {
            const investmentLevel = calculateInvestmentLevel();
            const costs = getInvestmentCosts(investmentLevel);
            
            const html = `
                <div class="investment-title">üí∞ Desglose de Inversi√≥n Estimada</div>
                <div class="cost-grid">
                    <div class="cost-item">
                        <div class="cost-amount">$${costs.initial}</div>
                        <div class="cost-description">Inversi√≥n Inicial</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-amount">$${costs.monthly}</div>
                        <div class="cost-description">Costo Mensual</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-amount">$${costs.sixMonths}</div>
                        <div class="cost-description">Total 6 Meses</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-amount">$${costs.yearly}</div>
                        <div class="cost-description">Total Anual</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px; opacity: 0.9;">
                    <strong>Opciones de Financiamiento:</strong> ${costs.financing}
                </div>
            `;
            
            document.getElementById('investmentBreakdown').innerHTML = html;
        }

        // Generar timeline de tratamiento
        function generateTimeline() {
            const timelineData = getTimelineData();
            
            const html = `
                <div class="timeline-title">üìÖ Cronograma de Tratamiento Personalizado</div>
                <div class="timeline-steps">
                    ${timelineData.map((step, index) => `
                        <div class="timeline-step">
                            <div class="step-number">${index + 1}</div>
                            <div class="step-title">${step.title}</div>
                            <div class="step-description">${step.description}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('treatmentTimeline').innerHTML = html;
        }

        // Generar recomendaciones espec√≠ficas
        function generateRecommendations() {
            const recommendations = getSpecificRecommendations();
            
            const html = `
                <div class="recommendations-title">üí° Recomendaciones Espec√≠ficas</div>
                <div class="recommendation-grid">
                    ${recommendations.map(rec => `
                        <div class="recommendation-item">
                            <h4>${rec.title}</h4>
                            <p>${rec.description}</p>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('specificRecommendations').innerHTML = html;
        }

        // Generar alertas importantes
        function generateAlerts() {
            const alerts = getImportantAlerts();
            
            if (alerts.length > 0) {
                const html = alerts.map(alert => `
                    <div class="alert alert-${alert.type}">
                        <strong>${alert.title}</strong><br>
                        ${alert.message}
                    </div>
                `).join('');
                
                document.getElementById('importantAlerts').innerHTML = html;
            }
        }

        // Funciones de acci√≥n mejoradas
        async function scheduleConsultation() {
            const btn = document.getElementById('btnSchedule');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Procesando...';
                
                const datos = allPatientData.datosBasicos || allPatientData.datos_basicos || {};
                const message = `Hola Dr. Moya, he completado la evaluaci√≥n de Vitiligo y me gustar√≠a agendar una consulta.

Mis datos:
- Nombre: ${datos.nombre || 'No especificado'}
- Email: ${datos.email || 'No especificado'}
- Pa√≠s: ${(allPatientData.capacidadInversion || allPatientData.capacidad_inversion || {}).pais_residencia || 'No especificado'}
- ID de Evaluaci√≥n: ${currentEvaluationId || 'Local'}

¬øCu√°ndo podr√≠amos programar la primera consulta?`;

                const encodedMessage = encodeURIComponent(message);
                window.open(`https://wa.me/13055550123?text=${encodedMessage}`, '_blank');
                
                showAlert('Redirigiendo a WhatsApp...', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al abrir WhatsApp', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function downloadPDF() {
            const btn = document.getElementById('btnPDF');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Generando PDF...';
                
                if (currentReportId) {
                    // Intentar generar PDF en el servidor
                    const response = await fetch(`${API_BASE}/reporte/pdf?reporte_id=${currentReportId}`, {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.pdf_url) {
                            window.open(result.pdf_url, '_blank');
                            showAlert('PDF generado exitosamente', 'success');
                            return;
                        }
                    }
                }
                
                // Fallback: usar impresi√≥n del navegador
                window.print();
                showAlert('Use Ctrl+P o Cmd+P para guardar como PDF', 'info');
                
            } catch (error) {
                console.error('Error:', error);
                window.print();
                showAlert('Fallback: Use la funci√≥n de impresi√≥n', 'warning');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function sendByEmail() {
            const btn = document.getElementById('btnEmail');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Enviando...';
                
                if (currentReportId) {
                    // Intentar env√≠o desde el servidor
                    const response = await fetch(`${API_BASE}/reporte/enviar-email`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            reporte_id: currentReportId
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            showAlert('Reporte enviado por email exitosamente', 'success');
                            return;
                        }
                    }
                }
                
                // Fallback: abrir cliente de email
                const datos = allPatientData.datosBasicos || allPatientData.datos_basicos || {};
                const subject = `Reporte de Evaluaci√≥n Vitiligo - ${datos.nombre || 'Paciente'}`;
                const body = `Adjunto mi reporte completo de evaluaci√≥n de Vitiligo.

Por favor revise y confirme recepci√≥n para proceder con el agendamiento de consulta.

ID de Evaluaci√≥n: ${currentEvaluationId || 'Local'}

Saludos cordiales.`;

                window.open(`mailto:info@drmoya.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
                showAlert('Cliente de email abierto', 'info');
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al enviar email', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function saveToCloud() {
            const btn = document.getElementById('btnSave');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Guardando...';
                
                // Intentar guardar en el servidor
                const response = await fetch(`${API_BASE}/evaluacion/guardar-paso`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        paso: 'reporte_completo',
                        datos: allPatientData
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showAlert('Datos guardados en la nube exitosamente', 'success');
                        return;
                    }
                }
                
                // Fallback: guardar en localStorage
                localStorage.setItem('reporteCompleto', JSON.stringify(allPatientData));
                localStorage.setItem('reporteFecha', new Date().toISOString());
                showAlert('Datos guardados localmente como respaldo', 'warning');
                
            } catch (error) {
                console.error('Error:', error);
                localStorage.setItem('reporteCompleto', JSON.stringify(allPatientData));
                showAlert('Error del servidor - datos guardados localmente', 'warning');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Funci√≥n auxiliar para mostrar alertas
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '400px';
            alertDiv.innerHTML = message;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Funciones auxiliares para obtener datos (implementar todas las funciones necesarias)
        function getTimeDescription(time) {
            const descriptions = {
                'menos_3m': 'Menos de 3 meses',
                '3m_6m': '3 a 6 meses',
                '6m_1a': '6 meses a 1 a√±o',
                '1a_2a': '1 a 2 a√±os',
                '2a_5a': '2 a 5 a√±os',
                '5a_10a': '5 a 10 a√±os',
                'mas_10a': 'M√°s de 10 a√±os'
            };
            return descriptions[time] || 'No especificado';
        }

        function getProgressionDescription(progression) {
            const descriptions = {
                'estable': 'Estable (sin crecimiento)',
                'lenta': 'Progresi√≥n lenta',
                'rapida': 'Progresi√≥n r√°pida'
            };
            return descriptions[progression] || 'No especificado';
        }

        function getTotalDLQI(vitiligo) {
            if (vitiligo.dlqiScores || vitiligo.dlqi_scores) {
                const scores = vitiligo.dlqiScores || vitiligo.dlqi_scores;
                return Object.values(scores).reduce((sum, score) => sum + (parseInt(score) || 0), 0);
            }
            return vitiligo.dlqi_total || '0';
        }

        function calculateInvestmentLevel() {
            const capacidad = allPatientData.capacidadInversion || allPatientData.capacidad_inversion || {};
            let score = 0;

            const monthly = capacidad.monto_mensual_sostenible;
            if (monthly === 'mas_3000' || monthly === '2000_3000') score += 3;
            else if (monthly === '1000_2000' || monthly === '500_1000') score += 2;
            else if (monthly === '200_500') score += 1;

            const immediate = capacidad.monto_disponible_inmediato;
            if (immediate === 'mas_10000' || immediate === '5000_10000') score += 3;
            else if (immediate === '2500_5000' || immediate === '1000_2500') score += 2;
            else if (immediate === '500_1000') score += 1;

            if (score >= 5) return 3;
            else if (score >= 3) return 2;
            else return 1;
        }

        function calculateOverallRisk() {
            let riskScore = 0;
            const antecedentes = allPatientData.antecedentes || {};
            const vitiligo = allPatientData.vitiligoActual || allPatientData.vitiligo_actual || {};
            const datos = allPatientData.datosBasicos || allPatientData.datos_basicos || {};

            if (datos.edad < 20) riskScore += 2;
            else if (datos.edad < 30) riskScore += 1;

            const progression = vitiligo.progresion_selected || vitiligo.progresion;
            if (progression === 'rapida') riskScore += 3;
            else if (progression === 'lenta') riskScore += 2;

            const vasi = parseFloat(vitiligo.vasi_total || 0);
            if (vasi > 25) riskScore += 3;
            else if (vasi > 10) riskScore += 2;
            else if (vasi > 5) riskScore += 1;

            if (riskScore <= 3) return 'low';
            else if (riskScore <= 7) return 'medium';
            else return 'high';
        }

        function getFitzpatrickData(type) {
            const data = {
                1: { 
                    name: 'Piel Muy Clara', 
                    protocol: 'Dosis inicial: 280-300 mJ/cm¬≤, incrementos 10%, protecci√≥n SPF 50+' 
                },
                2: { 
                    name: 'Piel Clara', 
                    protocol: 'Dosis inicial: 300-350 mJ/cm¬≤, incrementos 15%, protecci√≥n SPF 30-50+' 
                },
                3: { 
                    name: 'Piel Intermedia', 
                    protocol: 'Dosis inicial: 440-500 mJ/cm¬≤, incrementos 15-20%, candidato ideal para terapias combinadas' 
                },
                4: { 
                    name: 'Piel Morena Clara', 
                    protocol: 'Dosis inicial: 500-600 mJ/cm¬≤, incrementos 20%, menor riesgo de fotosensibilidad' 
                },
                5: { 
                    name: 'Piel Morena', 
                    protocol: 'Dosis inicial: 650-800 mJ/cm¬≤, incrementos 20-25%, protocolo intensivo recomendado' 
                },
                6: { 
                    name: 'Piel Negra', 
                    protocol: 'Dosis inicial: 800-1000 mJ/cm¬≤, incrementos 25%, protocolo multimodal agresivo' 
                }
            };
            return data[type] || { name: 'No evaluado', protocol: 'Evaluaci√≥n requerida' };
        }

        function getRiskData(level) {
            const data = {
                low: {
                    title: 'Bajo Riesgo',
                    description: 'Su perfil indica un riesgo bajo de complicaciones. Con manejo adecuado y seguimiento regular, se pueden esperar resultados favorables.'
                },
                medium: {
                    title: 'Riesgo Moderado',
                    description: 'Su perfil muestra un riesgo moderado. Es importante iniciar tratamiento preventivo y realizar seguimiento regular para evitar progresi√≥n.'
                },
                high: {
                    title: 'Alto Riesgo',
                    description: 'Su perfil indica un riesgo alto de progresi√≥n. Se recomienda intervenci√≥n inmediata y seguimiento estrecho especializado.'
                }
            };
            return data[level];
        }

        // Implementar todas las dem√°s funciones auxiliares necesarias...
        function getInvestmentLevelDescription(level) {
            const descriptions = {
                1: 'Esencial - Presupuesto Limitado',
                2: 'Integral - Inversi√≥n Moderada',
                3: 'Premium - Inversi√≥n Completa'
            };
            return descriptions[level];
        }

        function getAmountDescription(amount) {
            const descriptions = {
                '0_100': '$0 - $100',
                '100_300': '$100 - $300',
                '300_500': '$300 - $500',
                '500_1000': '$500 - $1,000',
                '1000_2500': '$1,000 - $2,500',
                '2500_5000': '$2,500 - $5,000',
                '5000_10000': '$5,000 - $10,000',
                'mas_10000': 'M√°s de $10,000',
                '0_50': '$0 - $50',
                '50_100': '$50 - $100',
                '100_200': '$100 - $200',
                '200_500': '$200 - $500',
                '500_1000': '$500 - $1,000',
                '1000_2000': '$1,000 - $2,000',
                '2000_3000': '$2,000 - $3,000',
                'mas_3000': 'M√°s de $3,000'
            };
            return descriptions[amount] || 'No especificado';
        }

        function getPriorityDescription(priority) {
            const descriptions = {
                'baja': 'Baja prioridad',
                'media': 'Prioridad media',
                'alta': 'Alta prioridad',
                'urgente': 'Urgente'
            };
            return descriptions[priority] || 'No especificado';
        }

        function getUrgencyLevel(priority) {
            const levels = {
                'baja': 'üü¢ Baja',
                'media': 'üü° Media',
                'alta': 'üü† Alta',
                'urgente': 'üî¥ Urgente'
            };
            return levels[priority] || '‚ö™ No especificado';
        }

        function getTreatmentPlanData(level) {
            const plans = {
                1: {
                    title: 'üî¥ Plan Esencial - Protocolo B√°sico Efectivo',
                    consultations: [
                        'Consulta virtual inicial completa (90 min)',
                        'Evaluaci√≥n dermatol√≥gica especializada',
                        'An√°lisis fotogr√°fico digital',
                        'Seguimiento mensual virtual (30 min)'
                    ],
                    treatments: [
                        'Protocolo b√°sico con suplementos esenciales',
                        'Fototerapia UVB-NB casera supervisada',
                        'Corticoides t√≥picos especializados',
                        'Vitaminas y antioxidantes espec√≠ficos'
                    ],
                    studies: [
                        'Perfil tiroideo b√°sico',
                        'Vitamina D y B12',
                        'Hemograma completo',
                        'Fotograf√≠as de seguimiento mensuales'
                    ],
                    followUp: [
                        'Consultas virtuales mensuales',
                        'Ajustes de protocolo seg√∫n evoluci√≥n',
                        'Acceso a grupo de WhatsApp de soporte',
                        'Manual digital completo incluido'
                    ]
                },
                2: {
                    title: 'üü° Plan Integral - Protocolo Avanzado Personalizado',
                    consultations: [
                        'Consulta inicial presencial o virtual premium (120 min)',
                        'Evaluaci√≥n multidisciplinaria completa',
                        'An√°lisis gen√©tico por saliva incluido',
                        'Seguimiento quincenal especializado'
                    ],
                    treatments: [
                        'Protocolo avanzado personalizado',
                        'Fototerapia UVB-NB profesional',
                        'Inhibidores de calcineurina de √∫ltima generaci√≥n',
                        'Medicamentos sist√©micos cuando sea necesario'
                    ],
                    studies: [
                        'Panel gen√©tico completo para Vitiligo',
                        'Perfil autoinmune especializado',
                        'Screening de tuberculosis para biol√≥gicos',
                        'Laboratorios especializados cada 3 meses'
                    ],
                    followUp: [
                        'Consultas quincenales primeros 3 meses',
                        'Acceso VIP a consultas de emergencia',
                        'Coordinaci√≥n con especialistas adicionales',
                        'Plan familiar preventivo incluido'
                    ]
                },
                3: {
                    title: 'üü¢ Plan Premium - Protocolo Completo VIP',
                    consultations: [
                        'Consulta presencial en Miami (d√≠a completo)',
                        'Evaluaci√≥n integral con equipo multidisciplinario',
                        'Segunda opini√≥n internacional incluida',
                        'Seguimiento semanal personalizado'
                    ],
                    treatments: [
                        'Protocolo completo con todos los tratamientos disponibles',
                        'Tratamientos biol√≥gicos de √∫ltima generaci√≥n',
                        'Terapias experimentales aprobadas',
                        'Microinjertos y cirug√≠a cuando sea apropiado'
                    ],
                    studies: [
                        'An√°lisis gen√©tico completo familiar',
                        'Estudios de investigaci√≥n participativos',
                        'Monitoreo de biomarcadores avanzados',
                        'Laboratorios mensuales completos'
                    ],
                    followUp: [
                        'Acceso directo 24/7 al Dr. Moya',
                        'Coordinaci√≥n con centros internacionales',
                        'Seguimiento de por vida con descuentos',
                        'Garant√≠a de resultados premium'
                    ]
                }
            };
            return plans[level];
        }

        function getInvestmentCosts(level) {
            const costs = {
                1: {
                    initial: '500',
                    monthly: '350',
                    sixMonths: '2,600',
                    yearly: '4,700',
                    financing: 'Plan de pagos 6 cuotas sin intereses'
                },
                2: {
                    initial: '1,200',
                    monthly: '850',
                    sixMonths: '6,300',
                    yearly: '11,400',
                    financing: 'Financiamiento hasta 12 meses, seguro m√©dico aplicable'
                },
                3: {
                    initial: '2,500',
                    monthly: '2,000',
                    sixMonths: '14,500',
                    yearly: '26,500',
                    financing: 'Planes de financiamiento personalizados, coordinaci√≥n con seguros internacionales'
                }
            };
            return costs[level];
        }

        function getTimelineData() {
            return [
                {
                    title: 'Semana 1-2',
                    description: 'Consulta inicial, evaluaci√≥n completa, inicio de protocolo b√°sico'
                },
                {
                    title: 'Mes 1',
                    description: 'Ajuste de tratamientos, primera evaluaci√≥n de respuesta'
                },
                {
                    title: 'Mes 2-3',
                    description: 'Optimizaci√≥n del protocolo, primeros signos de mejora'
                },
                {
                    title: 'Mes 4-6',
                    description: 'Consolidaci√≥n de resultados, evaluaci√≥n de repigmentaci√≥n'
                },
                {
                    title: 'Mes 7-12',
                    description: 'Mantenimiento y optimizaci√≥n continua'
                },
                {
                    title: 'A√±o 2+',
                    description: 'Seguimiento a largo plazo, prevenci√≥n de reca√≠das'
                }
            ];
        }

        function getSpecificRecommendations() {
            return [
                {
                    title: 'üåû Protecci√≥n Solar',
                    description: 'Usar protector solar SPF 50+ diariamente en √°reas afectadas, reaplicar cada 2 horas'
                },
                {
                    title: 'üíä Suplementaci√≥n',
                    description: 'Vitamina D3 4000 UI/d√≠a, Vitamina B12 1000 mcg/d√≠a, √Åcido f√≥lico 5 mg/d√≠a'
                },
                {
                    title: 'üßò Manejo del Estr√©s',
                    description: 'T√©cnicas de relajaci√≥n, ejercicio regular, considerar apoyo psicol√≥gico si es necesario'
                },
                {
                    title: 'ü•ó Nutrici√≥n',
                    description: 'Dieta rica en antioxidantes, evitar alimentos inflamatorios, considerar eliminaci√≥n de gluten si hay sensibilidad'
                },
                {
                    title: '‚ö†Ô∏è Evitar Trauma',
                    description: 'Proteger la piel de cortes, fricciones excesivas y quemaduras (fen√≥meno de Koebner)'
                },
                {
                    title: 'üì∏ Monitoreo',
                    description: 'Fotograf√≠as mensuales para seguimiento, registro de cambios y factores desencadenantes'
                }
            ];
        }

        function getImportantAlerts() {
            const alerts = [];
            const vitiligo = allPatientData.vitiligoActual || allPatientData.vitiligo_actual || {};
            const capacidad = allPatientData.capacidadInversion || allPatientData.capacidad_inversion || {};
            
            // Alerta por progresi√≥n r√°pida
            if (vitiligo.progresion === 'rapida' || vitiligo.progresion_selected === 'rapida') {
                alerts.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Progresi√≥n R√°pida Detectada',
                    message: 'Su Vitiligo muestra progresi√≥n r√°pida. Se recomienda iniciar tratamiento inmediatamente para prevenir mayor extensi√≥n.'
                });
            }

            // Alerta por VASI alto
            const vasi = parseFloat(vitiligo.vasi_total || 0);
            if (vasi > 25) {
                alerts.push({
                    type: 'warning',
                    title: 'üîç Vitiligo Extenso',
                    message: 'Su √≠ndice VASI indica Vitiligo extenso. El tratamiento temprano es crucial para mejores resultados.'
                });
            }

            // Alerta por DLQI alto
            const dlqi = getTotalDLQI(vitiligo);
            if (dlqi > 15) {
                alerts.push({
                    type: 'info',
                    title: 'üíô Impacto en Calidad de Vida',
                    message: 'Su puntuaci√≥n DLQI indica impacto significativo en calidad de vida. Considere apoyo psicol√≥gico complementario.'
                });
            }

            // Alerta por prioridad urgente
            if (capacidad.prioridad_tratamiento === 'urgente') {
                alerts.push({
                    type: 'error',
                    title: 'üö® Tratamiento Urgente',
                    message: 'Ha indicado que el tratamiento es urgente. Recomendamos agendar consulta inmediatamente.'
                });
            }

            // Alerta positiva
            alerts.push({
                type: 'success',
                title: '‚úÖ Evaluaci√≥n Completa Finalizada',
                message: 'Ha completado exitosamente la evaluaci√≥n integral. Ahora tiene un plan personalizado basado en evidencia cient√≠fica.'
            });

            return alerts;
        }

        function generateRiskFactorDetails() {
            return '<li>An√°lisis basado en antecedentes familiares y personales</li><li>Evaluaci√≥n de progresi√≥n actual</li><li>Factores ambientales y de estilo de vida</li>';
        }

        function generateBodyDistribution(vitiligo) {
            const regions = ['head_neck', 'upper_trunk', 'lower_trunk', 'upper_extremities', 'lower_extremities', 'genital'];
            const affected = regions.filter(region => vitiligo[region + '_check']).length;
            return `${affected} regi√≥n(es) corporal(es) afectada(s)`;
        }

        function getVASIClassification(vasi) {
            const score = parseFloat(vasi || 0);
            if (score < 10) return 'Leve';
            else if (score < 25) return 'Moderado';
            else if (score < 50) return 'Severo';
            else return 'Muy severo';
        }

        function getDLQIImpact(dlqi) {
            const score = parseInt(dlqi || 0);
            if (score <= 5) return 'Impacto peque√±o';
            else if (score <= 10) return 'Impacto moderado';
            else if (score <= 20) return 'Impacto grande';
            else return 'Impacto extremo';
        }

        function generatePreviousTreatments(vitiligo) {
            if (vitiligo.tratamientos_previos === 'no') {
                return 'No ha recibido tratamientos previos';
            }
            return 'Ha recibido tratamientos previos (detalles en evaluaci√≥n completa)';
        }

        function generateSymptoms(vitiligo) {
            // Simplificado para el reporte
            return 'Evaluados seg√∫n cuestionario de s√≠ntomas espec√≠ficos';
        }

        // Funci√≥n para integrar con el backend y enviar datos
        async function sendDataToBackend() {
            try {
                const allData = {
                    datosBasicos: allPatientData.datosBasicos || allPatientData.datos_basicos,
                    fitzpatrick: allPatientData.fitzpatrick || allPatientData.fitzpatrick_data,
                    antecedentes: allPatientData.antecedentes,
                    vitiligoActual: allPatientData.vitiligoActual || allPatientData.vitiligo_actual,
                    capacidadInversion: allPatientData.capacidadInversion || allPatientData.capacidad_inversion
                };

                // Enviar a guardar_datos.php mejorado
                const response = await fetch('/pidasalud/protocolo-vitiligo/api.php/evaluacion/guardar-completo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        evaluacion_completa: allData,
                        reporte_generado: true,
                        fecha_reporte: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('‚úÖ Datos enviados al backend exitosamente');
                        return result;
                    }
                }
                throw new Error('Error en respuesta del servidor');
                
            } catch (error) {
                console.error('‚ùå Error enviando datos al backend:', error);
                // Continuar con funcionalidad local como fallback
                return null;
            }
        }

        // Funci√≥n para verificar estado de usuario
        async function checkUserSession() {
            try {
                const response = await fetch(`${API_BASE}/auth/status`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.authenticated) {
                        return result.user;
                    }
                }
                return null;
            } catch (error) {
                console.log('Usuario no autenticado o error de sesi√≥n');
                return null;
            }
        }

        // Funci√≥n mejorada para inicializar el reporte
        async function initializeReportAdvanced() {
            try {
                showLoadingState();
                
                // Verificar sesi√≥n del usuario
                const user = await checkUserSession();
                
                if (user) {
                    console.log(`üë§ Usuario autenticado: ${user.name}`);
                    // Cargar datos desde el servidor
                    await loadDataFromServer();
                } else {
                    console.log('üì± Modo local - usando localStorage');
                    // Usar datos locales
                    const localData = getLocalStorageData();
                    if (localData && Object.keys(localData).length > 0) {
                        allPatientData = localData;
                        await generateReportFromData();
                    } else {
                        throw new Error('No hay datos disponibles para generar el reporte');
                    }
                }
                
                // Enviar datos al backend si es posible
                await sendDataToBackend();
                
            } catch (error) {
                console.error('Error en inicializaci√≥n avanzada:', error);
                // Fallback a inicializaci√≥n b√°sica
                await initializeReport();
            }
        }

        // Funci√≥n para exportar datos en diferentes formatos
        function exportData(format = 'json') {
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `vitiligo-report-${timestamp}`;
            
            switch (format) {
                case 'json':
                    const jsonData = JSON.stringify(allPatientData, null, 2);
                    downloadFile(jsonData, `${filename}.json`, 'application/json');
                    break;
                    
                case 'csv':
                    const csvData = convertToCSV(allPatientData);
                    downloadFile(csvData, `${filename}.csv`, 'text/csv');
                    break;
                    
                default:
                    console.error('Formato no soportado');
            }
        }

        function convertToCSV(data) {
            // Funci√≥n simplificada para convertir datos a CSV
            const flatData = flattenObject(data);
            const headers = Object.keys(flatData);
            const values = Object.values(flatData);
            
            return [headers.join(','), values.map(v => `"${v}"`).join(',')].join('\n');
        }

        function flattenObject(obj, prefix = '') {
            const flattened = {};
            
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    const value = obj[key];
                    const newKey = prefix ? `${prefix}_${key}` : key;
                    
                    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                        Object.assign(flattened, flattenObject(value, newKey));
                    } else {
                        flattened[newKey] = Array.isArray(value) ? value.join('; ') : value;
                    }
                }
            }
            
            return flattened;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Agregar botones adicionales para exportar datos
        function addExportButtons() {
            const actionsDiv = document.querySelector('.actions');
            if (actionsDiv) {
                const exportButtons = `
                    <button class="btn btn-info" onclick="exportData('json')">üìä Exportar JSON</button>
                    <button class="btn btn-info" onclick="exportData('csv')">üìà Exportar CSV</button>
                `;
                actionsDiv.innerHTML += exportButtons;
            }
        }

        // Funci√≥n para mostrar estad√≠sticas del reporte
        function showReportStats() {
            const stats = {
                fechaEvaluacion: new Date().toLocaleDateString('es-ES'),
                tiempoCompletado: 'Variable seg√∫n el usuario',
                seccionesCompletadas: Object.keys(allPatientData).length,
                nivelRiesgo: calculateOverallRisk(),
                nivelInversion: calculateInvestmentLevel(),
                recomendacionPrincipal: getMainRecommendation()
            };
            
            console.log('üìä Estad√≠sticas del Reporte:', stats);
            return stats;
        }

        function getMainRecommendation() {
            const investmentLevel = calculateInvestmentLevel();
            const riskLevel = calculateOverallRisk();
            
            if (riskLevel === 'high' && investmentLevel >= 2) {
                return 'Tratamiento inmediato con protocolo avanzado';
            } else if (riskLevel === 'medium') {
                return 'Iniciar tratamiento preventivo con seguimiento regular';
            } else {
                return 'Protocolo b√°sico con monitoreo continuo';
            }
        }

        // Inicializar funciones adicionales cuando se complete el reporte
        document.addEventListener('DOMContentLoaded', function() {
            // Usar inicializaci√≥n avanzada si est√° disponible
            if (typeof initializeReportAdvanced === 'function') {
                initializeReportAdvanced();
            } else {
                initializeReport();
            }
            
            // Agregar funcionalidades adicionales
            setTimeout(() => {
                addExportButtons();
                showReportStats();
            }, 2000);
        });
    </script>
</body>
</html>
